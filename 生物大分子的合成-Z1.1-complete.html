<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>生物大分子的合成 Z1.1</title>
<!--
  本文件是“生物大分子的合成”交互演示的整合版本。

  它基于先前的蛋白质、DNA/RNA 和多糖演示页面重新整理，
  并新增了脂肪/磷脂合成模块。代码中大量使用注释来解释
  每一部分的功能与关键参数，以方便后续维护与调整。

  如果需要调整某些交互距离或样式，请查找相应的常量：
    * PROT_BOND_NEAR  - 蛋白质缩合时的判定距离
    * DNA_OUT         - DNA/RNA 碱基外移距离
    * DNA_BOND_NEAR   - DNA/RNA 5′-3′ 成键判定距离
    * DNA_PAIR_NEAR   - 碱基配对的判定距离
    * POLY_BOND_NEAR  - 多糖缩合的判定距离
    * LIP_BOND_NEAR   - 脂肪酯化/皂化判定距离

  所有连线均以“外边缘对外边缘”方式计算，避免插入中心。

  作者：自动生成 (2025/8/17)
-->
<style>
  /* 全局主题：深色背景并配合柔和渐变，提升高端质感 */
  :root{
    --bg: #0f172a;
    --ink: #f8fafc;
    --panel-bg: rgba(14, 23, 38, 0.8);
    --panel-border: #334155;
    --tab-bg: #1e293b;
    --tab-active-bg: #334155;
    --tab-color: #a5b4fc;
    --tab-active-color: #fff;
    --accent: #38bdf8;
    --bond-color: #fbbf24;
    --water-color: #60a5fa;
    --soap-color: #34d399;
  }

  /* 背景渐变动画 */
  body{
    margin:18px;
    font-family: system-ui,Segoe UI,Helvetica,Arial;
    color: var(--ink);
    background: linear-gradient(135deg,#0f172a,#0e2143,#1e293b,#334155,#475569);
    background-size: 400% 400%;
    animation: gradientMove 30s ease infinite;
  }
  @keyframes gradientMove {
    0%{background-position:0% 50%;}
    50%{background-position:100% 50%;}
    100%{background-position:0% 50%;}
  }
  h1{
    font-size:22px;
    margin:0 0 12px;
    text-align:center;
  }
  .tabs{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    justify-content:center;
    margin-bottom:14px;
  }
  .tab-btn{
    padding:8px 16px;
    border:1px solid var(--panel-border);
    border-radius:8px;
    background:var(--tab-bg);
    color:var(--tab-color);
    font-weight:600;
    cursor:pointer;
    user-select:none;
    transition:background .2s;
  }
  .tab-btn.active{
    background:var(--tab-active-bg);
    color:var(--tab-active-color);
  }
  .tab{display:none;}
  .tab.active{display:block;}
  .panel{
    position:relative;
    width:100%;
    height:740px;
    background:var(--panel-bg);
    border:1px solid var(--panel-border);
    border-radius:12px;
    overflow:hidden;
  }
  /* 控件区域：右上角放置工具按钮，如放水/NaOH/重置 */
  .controls{
    position:absolute;
    right:10px;
    top:10px;
    display:flex;
    gap:8px;
    z-index:5;
  }
  .btn{
    padding:6px 12px;
    font-size:12px;
    border-radius:8px;
    border:1px solid var(--accent);
    background:rgba(56,189,248,0.15);
    color:var(--accent);
    cursor:pointer;
  }
  /* 通用水滴/肥皂样式 */
  .water,
  .naoh,
  .soap{
    position:absolute;
    width:40px;
    height:40px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:10px;
    font-weight:700;
    cursor:pointer;
    user-select:none;
    pointer-events:auto;
  }
  .water{
    background:radial-gradient(circle at 60% 35%,#c7e1ff,#60a5fa,#2563eb);
    color:#e0f2fe;
    border:2px solid #2563eb;
  }
  .naoh{
    background:radial-gradient(circle at 60% 35%,#d1fae5,#6ee7b7,#047857);
    color:#065f46;
    border:2px solid #047857;
  }
  .soap{
    background:radial-gradient(circle at 60% 35%,#fef3c7,#fde68a,#d97706);
    color:#7c2d12;
    border:2px solid #d97706;
    font-size:9px;
  }
  /* 蛋白质、DNA、RNA、多糖的面板使用 iframe 加载已有页面 */
  .embed{
    width:100%;
    height:100%;
    border:none;
  }
  /* ------ 脂肪合成样式 ------ */
  #tab-lipid .palette{
    position:absolute;
    left:0;
    right:0;
    top:0;
    min-height:150px;
    background:rgba(2,132,199,0.2);
    border-bottom:1px dashed var(--accent);
    padding:10px 14px;
    display:flex;
    gap:12px;
    align-items:flex-start;
    overflow-x:auto;
    backdrop-filter:blur(4px);
  }
  #tab-lipid .card{
    position:relative;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:grab;
    user-select:none;
    touch-action:none;
    border-radius:8px;
    font-weight:700;
    font-size:12px;
    color:var(--ink);
    box-shadow:0 2px 6px rgba(0,0,0,0.2);
  }
  /* 甘油：三个碳球 + 三个羟基；采用水平布局 */
  #tab-lipid .gly{
    width:200px;
    height:80px;
    background:rgba(253,224,71,0.2);
    border:1px solid #facc15;
    display:flex;
    align-items:center;
    justify-content:space-around;
    padding:6px;
  }
  #tab-lipid .gly .c{
    width:32px;
    height:32px;
    border-radius:50%;
    background:#facc15;
    border:2px solid #f59e0b;
    color:#78350f;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    font-size:14px;
    position:relative;
  }
  #tab-lipid .gly .oh{
    width:36px;
    height:18px;
    border-radius:6px;
    background:#fecaca;
    border:1px solid #dc2626;
    color:#7f1d1d;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    font-size:11px;
  }
  /* 脂肪酸：左侧羧基，右侧烃链，并在上方标注类型 */
  #tab-lipid .fa{
    min-width:220px;
    height:80px;
    background:rgba(255,255,255,0.1);
    border:1px solid #475569;
    display:flex;
    align-items:center;
    justify-content:flex-start;
    position:relative;
    padding:6px;
  }
  #tab-lipid .fa .hooc{
    width:40px;
    height:20px;
    border-radius:6px;
    background:#bbf7d0;
    border:1px solid #065f46;
    color:#065f46;
    font-weight:700;
    font-size:11px;
    display:flex;
    align-items:center;
    justify-content:center;
    margin-right:4px;
  }
  #tab-lipid .fa .chain{
    flex:1;
    height:20px;
    border-radius:6px;
    background:#e5e7eb;
    border:1px solid #9ca3af;
    color:#1f2937;
    font-size:10px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0 4px;
    overflow:hidden;
    white-space:nowrap;
  }
  #tab-lipid .fa .label{
    position:absolute;
    right:8px;
    top:-10px;
    background:#fef08a;
    color:#b45309;
    border:1px solid #b45309;
    border-radius:6px;
    padding:2px 4px;
    font-size:10px;
    font-weight:700;
  }
  /* 磷脂头：胆碱 + 磷酸 + OH */
  #tab-lipid .head{
    width:200px;
    height:80px;
    background:rgba(34,197,94,0.2);
    border:1px solid #059669;
    display:flex;
    align-items:center;
    justify-content:space-around;
    position:relative;
    padding:6px;
  }
  #tab-lipid .head .choline{
    width:50px;
    height:24px;
    border-radius:6px;
    background:#86efac;
    border:1px solid #047857;
    color:#064e3b;
    font-size:11px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
  }
  #tab-lipid .head .phos{
    width:28px;
    height:28px;
    border-radius:50%;
    background:#fef08a;
    border:2px solid #d97706;
    color:#92400e;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
  }
  #tab-lipid .head .ho{
    width:36px;
    height:18px;
    border-radius:6px;
    background:#fecaca;
    border:1px solid #ef4444;
    color:#7f1d1d;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:11px;
    font-weight:700;
  }
  /* 面板内部绘图 SVG 与连线样式 */
  #tab-lipid svg{
    position:absolute;
    left:0;
    top:0;
    width:100%;
    height:100%;
    pointer-events:none;
  }
  #tab-lipid .bond-line{
    stroke:var(--bond-color);
    stroke-width:4;
    stroke-linecap:round;
  }
  #tab-lipid .bond-label{
    font-size:11px;
    font-weight:700;
    fill:var(--ink);
  }
  #tab-lipid .hidden-text{
    visibility:hidden;
  }
</style>
</head>
<body>
<h1>生物大分子的合成 Z1.1</h1>
<!-- 标签按钮 -->
<div class="tabs">
  <button class="tab-btn active" data-tab="aa">蛋白质合成</button>
  <button class="tab-btn" data-tab="dna">DNA 合成</button>
  <button class="tab-btn" data-tab="poly">多糖合成</button>
  <button class="tab-btn" data-tab="lipid">脂肪合成</button>
</div>
<!-- 各区域面板 -->
<section id="tab-aa" class="tab active"><div class="panel">
  <!-- 使用 iframe 嵌入蛋白质交互页面。srcdoc 为 base64 解码后的 HTML。 -->
  <iframe class="embed" srcdoc="data:text/html;base64,PCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9InpoLUNOIj4KPGhlYWQ+CjxtZXRhIGNoYXJzZXQ9InV0Zi04IiAvPgo8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLGluaXRpYWwtc2NhbGU9MSIgLz4KPHRpdGxlPuawqOWfuumFuOWQiOaIkOekuuaEj++8iEhUTUwg5ryU56S677yJPC90aXRsZT4KPHN0eWxlPgogIDpyb290ewogICAgLS1jYXJkLXc6MTQwcHg7IC0tY2FyZC1oOjg2cHg7CiAgICAtLWdyb3VwLXc6MzZweDsgLS1ncm91cC1oOjI0cHg7CiAgICAtLWFjY2VudDojZjU5ZTBiOyAtLWJvbmQ6IzE2YTM0YTsgLS13YXRlci1iZzpyZ2JhKDU5LDEzMCwyNDYsMC4xMik7CiAgfQogIGJvZHl7Zm9udC1mYW1pbHk6c3lzdGVtLXVpLFNlZ29lIFVJLEhlbHZldGljYSxBcmlhbDsgbWFyZ2luOjE4cHg7IGJhY2tncm91bmQ6I2Y4ZmFmYzsgY29sb3I6IzBmMTcyYTt9CiAgaDF7Zm9udC1zaXplOjE4cHg7IG1hcmdpbjowIDAgOHB4O30KICBwe21hcmdpbjowIDAgMTJweDsgY29sb3I6IzMzNDE1NTt9CiAgI2JvYXJke3Bvc2l0aW9uOnJlbGF0aXZlOyB3aWR0aDoxMDAlOyBoZWlnaHQ6NjIwcHg7IGJhY2tncm91bmQ6I2ZmZjsgYm9yZGVyOjFweCBzb2xpZCAjZTZlZGYzOyBib3JkZXItcmFkaXVzOjEwcHg7IG92ZXJmbG93OmhpZGRlbjt9CiAgLmFhewogICAgcG9zaXRpb246YWJzb2x1dGU7IHdpZHRoOnZhcigtLWNhcmQtdyk7IGhlaWdodDp2YXIoLS1jYXJkLWgpOwogICAgY3Vyc29yOmdyYWI7IHVzZXItc2VsZWN0Om5vbmU7IHRvdWNoLWFjdGlvbjpub25lOwogICAgdHJhbnNmb3JtLW9yaWdpbjpjZW50ZXI7IHRyYW5zaXRpb246dHJhbnNmb3JtIC4xMnM7CiAgfQogIC5hYS5kcmFnZ2luZ3t0cmFuc2Zvcm06c2NhbGUoMS4wNCk7IHotaW5kZXg6MjAwMDsgY3Vyc29yOmdyYWJiaW5nO30KICAuY2FyZHsKICAgIHBvc2l0aW9uOmFic29sdXRlOyBsZWZ0OjZweDsgdG9wOjEwcHg7IHJpZ2h0OjZweDsgYm90dG9tOjEwcHg7CiAgICBib3JkZXItcmFkaXVzOjhweDsgYmFja2dyb3VuZDojZWVmMmZmOyBib3JkZXI6MnB4IHNvbGlkICM0MzM4Y2E7CiAgICBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsganVzdGlmeS1jb250ZW50OmNlbnRlcjsgZm9udC13ZWlnaHQ6NzAwOyBjb2xvcjojMDcxMDQzOwogIH0KICAuZ3JvdXB7CiAgICBwb3NpdGlvbjphYnNvbHV0ZTsgd2lkdGg6dmFyKC0tZ3JvdXAtdyk7IGhlaWdodDp2YXIoLS1ncm91cC1oKTsgYm9yZGVyLXJhZGl1czo2cHg7CiAgICBkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsganVzdGlmeS1jb250ZW50OmNlbnRlcjsgZm9udC1zaXplOjExcHg7IGZvbnQtd2VpZ2h0OjcwMDsKICAgIHRyYW5zaXRpb246b3BhY2l0eSAuNDJzOwogIH0KICAuYW1pbm97IGxlZnQ6LTE4cHg7IHRvcDpjYWxjKDUwJSAtIDEycHgpOyBiYWNrZ3JvdW5kOiNiZmRiZmU7IGJvcmRlcjoxcHggc29saWQgIzFlNDBhZjsgY29sb3I6IzFlM2E4YTt9CiAgLmNhcmJveHsgcmlnaHQ6LTE4cHg7IHRvcDpjYWxjKDUwJSAtIDEycHgpOyBiYWNrZ3JvdW5kOiNmZWNhY2E7IGJvcmRlcjoxcHggc29saWQgI2I5MWMxYzsgY29sb3I6IzdmMWQxZDt9CiAgLnNpZGUtaHsgcG9zaXRpb246YWJzb2x1dGU7IHdpZHRoOjMwcHg7IGhlaWdodDoyMHB4OyBsZWZ0OiA1NXB4OyB0b3A6LThweDsgYm9yZGVyLXJhZGl1czo0cHg7IGJhY2tncm91bmQ6I2YzZjRmNjsgYm9yZGVyOjFweCBzb2xpZCAjMTExODI3OyBkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2p1c3RpZnktY29udGVudDpjZW50ZXI7IGZvbnQtc2l6ZToxMXB4O30KICAuc2lkZS1yeyBwb3NpdGlvbjphYnNvbHV0ZTsgd2lkdGg6ODRweDsgaGVpZ2h0OjQwcHg7IGxlZnQ6IDMwcHg7IGJvdHRvbTotMjBweDsgYm9yZGVyLXJhZGl1czo2cHg7IGJhY2tncm91bmQ6I2U2ZmZmYTsgYm9yZGVyOjFweCBzb2xpZCAjMDQ3ODU3OyBmb250LXNpemU6MTFweDsgZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyOyBmb250LXdlaWdodDo3MDA7IGNvbG9yOiMwNjRlM2I7IH0KICAuYy1sYWJlbHsgcG9zaXRpb246YWJzb2x1dGU7IGxlZnQ6NTAlOyB0b3A6NTAlOyB0cmFuc2Zvcm06dHJhbnNsYXRlKC01MCUsLTUwJSk7IGZvbnQtc2l6ZToxNHB4OyBmb250LXdlaWdodDo5MDA7fQogIC53YXRlcnsKICAgIHBvc2l0aW9uOmFic29sdXRlOyBwYWRkaW5nOjZweCAxMHB4OyBib3JkZXItcmFkaXVzOjZweDsgYmFja2dyb3VuZDp2YXIoLS13YXRlci1iZyk7IGJvcmRlcjoxcHggc29saWQgcmdiYSg1OSwxMzAsMjQ2LDAuMzIpOwogICAgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGp1c3RpZnktY29udGVudDpjZW50ZXI7IGZvbnQtd2VpZ2h0OjgwMDsgY29sb3I6IzAzNjlhMTsgdXNlci1zZWxlY3Q6bm9uZTsgY3Vyc29yOnBvaW50ZXI7CiAgfQogIC8qIHBlcHRpZGUgYm9uZCB2aXN1YWxzIHdpbGwgYmUgZHJhd24gd2l0aCBTVkc7IHdlIGFsc28gY3JlYXRlIGEgc21hbGwgbGFiZWwgYm94IGFzIERPTSBmb3IgYWNjZXNzaWJpbGl0eSAqLwogICN1aSB7bWFyZ2luLXRvcDoxMHB4OyBjb2xvcjojMzc0MTUxOyBmb250LXNpemU6MTNweDt9CiAgLmhpbnR7bWFyZ2luLXRvcDo4cHg7Y29sb3I6IzQ3NTU2OTtmb250LXNpemU6MTNweDt9CiAgYnV0dG9uLnNtYWxse21hcmdpbi1sZWZ0OjZweDtwYWRkaW5nOjZweCAxMHB4O2JvcmRlci1yYWRpdXM6NnB4O2JvcmRlcjoxcHggc29saWQgI2NiZDVlMTtiYWNrZ3JvdW5kOiNmZmY7Y3Vyc29yOnBvaW50ZXI7fQo8L3N0eWxlPgo8L2hlYWQ+Cjxib2R5PgogIDxoMT7msKjln7rphbjlkIjmiJDmvJTnpLrvvIjnuq8gSFRNTC9KU++8iTwvaDE+CiAgPHA+5oqK5LiA5Liq5rCo5Z+66YW45ouW5Yiw5Y+m5LiA5Liq5rCo5Z+66YW455qE5Y+z5L6n6Z2g6L+R77yM5Y+v5Lul6Kem5Y+R57yp5ZCI5Y+N5bqU77ya55Sf5oiQIEjigoJP77yM5bm25b2i5oiQ6auY5Lqu55qE6IK96ZSuIDxjb2RlPi1OSC1DTy08L2NvZGU+44CCPC9wPgoKICA8ZGl2IGlkPSJib2FyZCI+CiAgICA8IS0tIFNWRyDlsYLvvJrnlKjkuo7nlLvnspfnur/kuI7ogr3plK7og4zmma8gLS0+CiAgICA8c3ZnIGlkPSJzdmciIHN0eWxlPSJwb3NpdGlvbjphYnNvbHV0ZTtsZWZ0OjA7dG9wOjA7d2lkdGg6MTAwJTtoZWlnaHQ6MTAwJTtwb2ludGVyLWV2ZW50czpub25lOyI+PC9zdmc+CiAgPC9kaXY+CgogIDxkaXYgaWQ9InVpIj4KICAgIDxzcGFuPuaPkOekuu+8muaLluWKqOWNoeeJh++8jOmdoOi/keinpuWPkei/nuaOpeOAgueCueWHuyBI4oKCTyDlj6/mlLbpm4bvvIjmiJbnrYnlvoXlhbboh6rooYzmtojlpLHvvInjgII8L3NwYW4+CiAgICA8YnV0dG9uIGNsYXNzPSJzbWFsbCIgaWQ9InJlc2V0Ij7ph43nva7luIPlsYA8L2J1dHRvbj4KICA8L2Rpdj4KCjxzY3JpcHQ+CigoKSA9PiB7CiAgY29uc3QgRVNTRU5USUFMID0gWyLkuq7msKjphbgiLCLlvILkuq7msKjphbgiLCLnvKzmsKjphbgiLCLom4vmsKjphbgiLCLoi6/kuJnmsKjphbgiLCLoibLmsKjphbgiLCLoi4/msKjphbgiLCLotZbmsKjphbgiLCLnu4TmsKjphbgiLCJDSDNDT09IPGJyPiAo5YiA5YiA5rCo6YW4KSIsIkNIM0NIMzxicj4gKOayu+mTqOawqOmFuCkiXTsKICBjb25zdCBib2FyZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdib2FyZCcpOwogIGNvbnN0IHN2ZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdmcnKTsKICBjb25zdCBDQVJEX1cgPSAxNDAsIENBUkRfSCA9IDg2OwogIGNvbnN0IGFtaW5vTGlzdCA9IFtdOwogIGNvbnN0IGJvbmRzID0gW107IC8vIHtsZWZ0SWQscmlnaHRJZCwgbGluZUVsZW1lbnQsIGxhYmVsR3JvdXB9CiAgY29uc3Qgd2F0ZXJzID0gW107CiAgLy8gZHJhZ2dpbmcgc3RhdGUgZm9yIHdhdGVycwogIGxldCBkcmFnV2F0ZXIgPSBudWxsOwoKICAvLyBicmVhayAoaHlkcm9seXplKSBhIGJvbmQgYnkgaW5kZXg6IHJlbW92ZSBTVkcgZWxlbWVudHMgYW5kIHJlc3RvcmUgc2lkZSBhdmFpbGFiaWxpdHkKICBmdW5jdGlvbiBicmVha0JvbmQoaW5kZXgpewogICAgY29uc3QgYiA9IGJvbmRzW2luZGV4XTsKICAgIGlmICghYikgcmV0dXJuOwogICAgY29uc3QgbGVmdCA9IGFtaW5vTGlzdC5maW5kKGE9PmEuaWQ9PT1iLmxlZnRJZCk7CiAgICBjb25zdCByaWdodCA9IGFtaW5vTGlzdC5maW5kKGE9PmEuaWQ9PT1iLnJpZ2h0SWQpOwogICAgLy8gcmVtb3ZlIHN2ZyB2aXN1YWxzCiAgICBpZiAoYi5saW5lICYmIGIubGluZS5wYXJlbnROb2RlKSBiLmxpbmUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChiLmxpbmUpOwogICAgaWYgKGIucmVjdCAmJiBiLnJlY3QucGFyZW50Tm9kZSkgYi5yZWN0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoYi5yZWN0KTsKICAgIGlmIChiLnR4dCAmJiBiLnR4dC5wYXJlbnROb2RlKSBiLnR4dC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGIudHh0KTsKICAgIC8vIHJlc3RvcmUgcGFydGljaXBhdGluZyBncm91cHMgYW5kIHNpZGUgYXZhaWxhYmlsaXR5CiAgICBpZiAobGVmdCl7CiAgICAgIGxlZnQucmlnaHRGcmVlID0gdHJ1ZTsKICAgICAgY29uc3QgY2FyID0gbGVmdC5lbC5xdWVyeVNlbGVjdG9yKCcuY2FyYm94Jyk7IGlmIChjYXIpIGNhci5zdHlsZS5vcGFjaXR5ID0gJzEnOwogICAgICBjb25zdCBoID0gbGVmdC5lbC5xdWVyeVNlbGVjdG9yKCcuc2lkZS1oJyk7IGlmIChoKSBoLnN0eWxlLm9wYWNpdHkgPSAnMSc7CiAgICB9CiAgICBpZiAocmlnaHQpewogICAgICByaWdodC5sZWZ0RnJlZSA9IHRydWU7CiAgICAgIGNvbnN0IGFtID0gcmlnaHQuZWwucXVlcnlTZWxlY3RvcignLmFtaW5vJyk7IGlmIChhbSkgYW0uc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgICAgY29uc3QgaDIgPSByaWdodC5lbC5xdWVyeVNlbGVjdG9yKCcuc2lkZS1oJyk7IGlmIChoMikgaDIuc3R5bGUub3BhY2l0eSA9ICcxJzsKICAgIH0KICAgIC8vIHJlbW92ZSB0aGUgYm9uZCByZWNvcmQKICAgIGJvbmRzLnNwbGljZShpbmRleCwxKTsKICAgIHJlZnJlc2hCb25kcygpOwogIH0KCgogIC8vIGluaXRpYWwgcG9zaXRpb25zCiAgZnVuY3Rpb24gcmFuZFBvcyhpKXsKICAgIGNvbnN0IG1hcmdpbiA9IDI0OwogICAgY29uc3QgY29scyA9IDM7CiAgICBjb25zdCB4ID0gbWFyZ2luICsgKGkgJSBjb2xzKSAqIChDQVJEX1cgKyA2MCk7CiAgICBjb25zdCB5ID0gbWFyZ2luICsgTWF0aC5mbG9vcihpIC8gY29scykgKiAoQ0FSRF9IICsgNDApOwogICAgcmV0dXJuIHt4LHl9OwogIH0KCiAgLy8gY3JlYXRlIEFBIERPTXMKICBFU1NFTlRJQUwuZm9yRWFjaCgobmFtZSxpKSA9PiB7CiAgICBjb25zdCBpZCA9ICdhYScgKyBpOwogICAgY29uc3QgcG9zID0gcmFuZFBvcyhpKTsKICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBlbC5jbGFzc05hbWUgPSAnYWEnOwogICAgZWwuc3R5bGUubGVmdCA9IHBvcy54ICsgJ3B4JzsKICAgIGVsLnN0eWxlLnRvcCA9IHBvcy55ICsgJ3B4JzsKICAgIGVsLmRhdGFzZXQuaWQgPSBpZDsKCiAgICBlbC5pbm5lckhUTUwgPSBgCiAgICAgIDxkaXYgY2xhc3M9ImNhcmQiPjxzcGFuIGNsYXNzPSJjLWxhYmVsIj5DPC9zcGFuPjwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJncm91cCBhbWlubyI+TkjigoI8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0iZ3JvdXAgY2FyYm94Ij5DT09IPC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InNpZGUtaCI+SDwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJzaWRlLXIiPiR7bmFtZX08L2Rpdj4KICAgIGA7CgogICAgYm9hcmQuYXBwZW5kQ2hpbGQoZWwpOwogICAgYW1pbm9MaXN0LnB1c2goe2lkLCBlbCwgcG9zOnsuLi5wb3N9LCBsZWZ0RnJlZTp0cnVlLCByaWdodEZyZWU6dHJ1ZSwgbmFtZX0pOwogIH0pOwoKICAvLyBkcmFnZ2luZyBsb2dpYyAocG9pbnRlciBldmVudHMpCiAgbGV0IGRyYWcgPSBudWxsOyAvLyB7aWQsb2Zmc2V0WCxvZmZzZXRZfQogIGJvYXJkLmFkZEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJkb3duJywgKGV2KSA9PiB7CiAgICBjb25zdCBhYSA9IGV2LnRhcmdldC5jbG9zZXN0KCcuYWEnKTsKICAgIGlmICghYWEpIHJldHVybjsKICAgIGFhLnNldFBvaW50ZXJDYXB0dXJlKGV2LnBvaW50ZXJJZCk7CiAgICBjb25zdCByZWN0ID0gYm9hcmQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICBjb25zdCBpZCA9IGFhLmRhdGFzZXQuaWQ7CiAgICBjb25zdCBpdGVtID0gYW1pbm9MaXN0LmZpbmQoYT0+YS5pZD09PWlkKTsKICAgIGNvbnN0IG94ID0gZXYuY2xpZW50WCAtIHJlY3QubGVmdCAtIGl0ZW0ucG9zLng7CiAgICBjb25zdCBveSA9IGV2LmNsaWVudFkgLSByZWN0LnRvcCAtIGl0ZW0ucG9zLnk7CiAgICBkcmFnID0ge2lkLCBveCwgb3ksIHBvaW50ZXJJZDpldi5wb2ludGVySWR9OwogICAgYWEuY2xhc3NMaXN0LmFkZCgnZHJhZ2dpbmcnKTsKICB9KTsKCiAgYm9hcmQuYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlcm1vdmUnLCAoZXYpID0+IHsKICAgIGlmIChkcmFnKSB7CiAgICAgIGNvbnN0IHJlY3QgPSBib2FyZC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgY29uc3QgeCA9IGV2LmNsaWVudFggLSByZWN0LmxlZnQgLSBkcmFnLm94OwogICAgICBjb25zdCB5ID0gZXYuY2xpZW50WSAtIHJlY3QudG9wIC0gZHJhZy5veTsKICAgICAgY29uc3QgaXRlbSA9IGFtaW5vTGlzdC5maW5kKGE9PmEuaWQ9PT1kcmFnLmlkKTsKICAgICAgaXRlbS5wb3MueCA9IHg7IGl0ZW0ucG9zLnkgPSB5OwogICAgICBpdGVtLmVsLnN0eWxlLmxlZnQgPSB4ICsgJ3B4JzsgaXRlbS5lbC5zdHlsZS50b3AgPSB5ICsgJ3B4JzsKICAgICAgLy8gdXBkYXRlIGJvbmRlZCBsaW5lcyBpZiBhbnkKICAgICAgcmVmcmVzaEJvbmRzKCk7CiAgICB9IGVsc2UgaWYgKGRyYWdXYXRlcikgewogICAgICBjb25zdCByZWN0ID0gYm9hcmQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIGNvbnN0IHggPSBldi5jbGllbnRYIC0gcmVjdC5sZWZ0IC0gZHJhZ1dhdGVyLm94OwogICAgICBjb25zdCB5ID0gZXYuY2xpZW50WSAtIHJlY3QudG9wIC0gZHJhZ1dhdGVyLm95OwogICAgICBkcmFnV2F0ZXIuZWwuc3R5bGUubGVmdCA9IHggKyAncHgnOwogICAgICBkcmFnV2F0ZXIuZWwuc3R5bGUudG9wID0geSArICdweCc7CiAgICB9CiAgfSk7CgogIGJvYXJkLmFkZEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJ1cCcsIChldikgPT4gewogICAgaWYgKGRyYWcpIHsKICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGAuYWFbZGF0YS1pZD0iJHtkcmFnLmlkfSJdYCk7CiAgICAgIGlmIChlbCkgZWwuY2xhc3NMaXN0LnJlbW92ZSgnZHJhZ2dpbmcnKTsKCiAgICAgIC8vIGFmdGVyIGRyb3AsIGNoZWNrIHByb3hpbWl0eSBmb3IgcG9zc2libGUgYm9uZAogICAgICBjb25zdCBkcmFnZ2VkID0gYW1pbm9MaXN0LmZpbmQoYT0+YS5pZD09PWRyYWcuaWQpOwogICAgICBsZXQgZm9ybWVkID0gZmFsc2U7CiAgICAgIGZvciAoY29uc3QgdGFyZ2V0IG9mIGFtaW5vTGlzdCkgewogICAgICAgIGlmICh0YXJnZXQuaWQgPT09IGRyYWdnZWQuaWQpIGNvbnRpbnVlOwogICAgICAgIC8vIGxlZnQtPnJpZ2h0IGNoZWNrOiBkcmFnZ2VkIHJpZ2h0IHNpZGUgbmVhciB0YXJnZXQgbGVmdCBzaWRlCiAgICAgICAgY29uc3QgZHJhZ2dlZFJpZ2h0WCA9IGRyYWdnZWQucG9zLnggKyBDQVJEX1c7CiAgICAgICAgY29uc3QgdGFyZ2V0TGVmdFggPSB0YXJnZXQucG9zLng7CiAgICAgICAgY29uc3QgbWlkWSA9IGRyYWdnZWQucG9zLnkgKyBDQVJEX0gvMjsKICAgICAgICBjb25zdCB0YXJnZXRNaWRZID0gdGFyZ2V0LnBvcy55ICsgQ0FSRF9ILzI7CiAgICAgICAgY29uc3QgZHggPSBNYXRoLmFicyhkcmFnZ2VkUmlnaHRYIC0gdGFyZ2V0TGVmdFgpOwogICAgICAgIGNvbnN0IGR5ID0gTWF0aC5hYnMobWlkWSAtIHRhcmdldE1pZFkpOwogICAgICAgIGlmIChkeCA8IDM2ICYmIGR5IDwgMzQgJiYgIWlzQm9uZGVkKGRyYWdnZWQuaWQsIHRhcmdldC5pZCkpIHsKICAgICAgICAgIGNvbnN0IGxlZnRDYW5kaWRhdGUgPSBhbWlub0xpc3QuZmluZChhID0+IGEuaWQgPT09IGRyYWdnZWQuaWQpOwogICAgICAgICAgY29uc3QgcmlnaHRDYW5kaWRhdGUgPSBhbWlub0xpc3QuZmluZChhID0+IGEuaWQgPT09IHRhcmdldC5pZCk7CiAgICAgICAgICBpZiAobGVmdENhbmRpZGF0ZSAmJiByaWdodENhbmRpZGF0ZSAmJiBsZWZ0Q2FuZGlkYXRlLnJpZ2h0RnJlZSAmJiByaWdodENhbmRpZGF0ZS5sZWZ0RnJlZSkgewogICAgICAgICAgICBmb3JtQm9uZChkcmFnZ2VkLmlkLCB0YXJnZXQuaWQpOwogICAgICAgICAgICBmb3JtZWQgPSB0cnVlOyBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gYWxzbyBjaGVjayByZXZlcnNlIChkcmFnZ2VkIGxlZnQgdG8gb3RoZXIncyByaWdodCkKICAgICAgICBjb25zdCBkcmFnZ2VkTGVmdFggPSBkcmFnZ2VkLnBvcy54OwogICAgICAgIGNvbnN0IHRhcmdldFJpZ2h0WCA9IHRhcmdldC5wb3MueCArIENBUkRfVzsKICAgICAgICBjb25zdCBkeDIgPSBNYXRoLmFicyhkcmFnZ2VkTGVmdFggLSB0YXJnZXRSaWdodFgpOwogICAgICAgIGlmIChkeDIgPCAzNiAmJiBkeSA8IDM0ICYmICFpc0JvbmRlZCh0YXJnZXQuaWQsIGRyYWdnZWQuaWQpKSB7CiAgICAgICAgICBjb25zdCBsZWZ0Q2FuZGlkYXRlID0gYW1pbm9MaXN0LmZpbmQoYSA9PiBhLmlkID09PSB0YXJnZXQuaWQpOwogICAgICAgICAgY29uc3QgcmlnaHRDYW5kaWRhdGUgPSBhbWlub0xpc3QuZmluZChhID0+IGEuaWQgPT09IGRyYWdnZWQuaWQpOwogICAgICAgICAgaWYgKGxlZnRDYW5kaWRhdGUgJiYgcmlnaHRDYW5kaWRhdGUgJiYgbGVmdENhbmRpZGF0ZS5yaWdodEZyZWUgJiYgcmlnaHRDYW5kaWRhdGUubGVmdEZyZWUpIHsKICAgICAgICAgICAgZm9ybUJvbmQodGFyZ2V0LmlkLCBkcmFnZ2VkLmlkKTsKICAgICAgICAgICAgZm9ybWVkID0gdHJ1ZTsgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBkcmFnID0gbnVsbDsKICAgICAgaWYgKGZvcm1lZCkgewogICAgICAgIC8vIHNtYWxsIHZpc3VhbCBmZWVkYmFjayBoYW5kbGVkIGJ5IHN0YXRlIGNoYW5nZXMKICAgICAgfQogICAgfSBlbHNlIGlmIChkcmFnV2F0ZXIpIHsKICAgICAgLy8gZHJvcCB3YXRlcjogY2hlY2sgaWYgcmVsZWFzZWQgbmVhciBhbnkgYm9uZCBtaWRwb2ludDsgaWYgc28sIGJyZWFrIHRoYXQgYm9uZCAoaHlkcm9seXNpcykKICAgICAgY29uc3QgcmVjdCA9IGJvYXJkLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICBjb25zdCB4ID0gZXYuY2xpZW50WCAtIHJlY3QubGVmdCAtIGRyYWdXYXRlci5veCArIDE2OyAvLyBjZW50ZXIKICAgICAgY29uc3QgeSA9IGV2LmNsaWVudFkgLSByZWN0LnRvcCAtIGRyYWdXYXRlci5veSArIDg7CiAgICAgIC8vIGZpbmQgbmVhcmVzdCBib25kIHdpdGhpbiB0aHJlc2hvbGQKICAgICAgbGV0IGZvdW5kSW5kZXggPSAtMTsKICAgICAgZm9yIChsZXQgaT0wO2k8Ym9uZHMubGVuZ3RoO2krKyl7CiAgICAgICAgY29uc3QgYiA9IGJvbmRzW2ldOwogICAgICAgIGNvbnN0IGxlZnQgPSBhbWlub0xpc3QuZmluZChhPT5hLmlkPT09Yi5sZWZ0SWQpOwogICAgICAgIGNvbnN0IHJpZ2h0ID0gYW1pbm9MaXN0LmZpbmQoYT0+YS5pZD09PWIucmlnaHRJZCk7CiAgICAgICAgaWYgKCFsZWZ0IHx8ICFyaWdodCkgY29udGludWU7CiAgICAgICAgY29uc3QgbXggPSAobGVmdC5wb3MueCArIENBUkRfVyArIHJpZ2h0LnBvcy54KS8yOwogICAgICAgIGNvbnN0IG15ID0gKGxlZnQucG9zLnkgKyBDQVJEX0gvMiArIHJpZ2h0LnBvcy55ICsgQ0FSRF9ILzIpLzI7CiAgICAgICAgY29uc3QgZHggPSBNYXRoLmh5cG90KG14IC0geCwgbXkgLSB5KTsKICAgICAgICBpZiAoZHggPCA0MCkgeyBmb3VuZEluZGV4ID0gaTsgYnJlYWs7IH0KICAgICAgfQogICAgICAvLyByZWxlYXNlIGRyYWdnaW5nIHN0YXRlCiAgICAgIGRyYWdXYXRlci5lbC5jbGFzc0xpc3QucmVtb3ZlKCdkcmFnZ2luZycpOwogICAgICBkcmFnV2F0ZXIuZWwucmVsZWFzZVBvaW50ZXJDYXB0dXJlKGRyYWdXYXRlci5wb2ludGVySWQpOwogICAgICBpZiAoZm91bmRJbmRleCA+PSAwKSB7CiAgICAgICAgLy8gYnJlYWsgdGhlIGJvbmQgYW5kIGNvbnN1bWUgdGhpcyB3YXRlcgogICAgICAgIGJyZWFrQm9uZChmb3VuZEluZGV4KTsKICAgICAgICByZW1vdmVXYXRlcihkcmFnV2F0ZXIuaWQpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGxlYXZlIHdhdGVyIHdoZXJlIGRyb3BwZWQKICAgICAgfQogICAgICBkcmFnV2F0ZXIgPSBudWxsOwogICAgfQogIH0pOwoKICBmdW5jdGlvbiBpc0JvbmRlZChsLHIpewogICAgcmV0dXJuIGJvbmRzLnNvbWUoYiA9PiBiLmxlZnRJZD09PWwgJiYgYi5yaWdodElkPT09cik7CiAgfQoKICAvLyBhbmltYXRlIGdyb3VwcyBmYWRlIHRoZW4gY3JlYXRlIGJvbmQgbGluZSArIHBlcHRpZGUgbGFiZWwgKyB3YXRlcgogIApmdW5jdGlvbiBmb3JtQm9uZChsZWZ0SWQsIHJpZ2h0SWQpewogICAgY29uc3QgbGVmdCA9IGFtaW5vTGlzdC5maW5kKGE9PmEuaWQ9PT1sZWZ0SWQpOwogICAgY29uc3QgcmlnaHQgPSBhbWlub0xpc3QuZmluZChhPT5hLmlkPT09cmlnaHRJZCk7CiAgICBpZiAoIWxlZnQgfHwgIXJpZ2h0KSByZXR1cm47CgogICAgLy8gSWYgcGFydGljaXBhdGluZyBzaWRlcyBhbHJlYWR5IHVzZWQsIGFib3J0CiAgICBpZiAoIWxlZnQucmlnaHRGcmVlIHx8ICFyaWdodC5sZWZ0RnJlZSkgcmV0dXJuOwoKICAgIC8vIEZhZGUgb3V0IG9ubHkgdGhlIHBhcnRpY2lwYXRpbmcgZ3JvdXBzOiBsZWZ0J3MgQ09PSCBhbmQgcmlnaHQncyBOSDIKICAgIGNvbnN0IGxlZnRDYXJib3ggPSBsZWZ0LmVsLnF1ZXJ5U2VsZWN0b3IoJy5jYXJib3gnKTsKICAgIGNvbnN0IHJpZ2h0QW1pbm8gID0gcmlnaHQuZWwucXVlcnlTZWxlY3RvcignLmFtaW5vJyk7CiAgICBpZiAobGVmdENhcmJveCkgbGVmdENhcmJveC5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgaWYgKHJpZ2h0QW1pbm8pIHJpZ2h0QW1pbm8uc3R5bGUub3BhY2l0eSA9ICcwJzsKCiAgICAvLyBtYXJrIHNpZGVzIGFzIHVzZWQgc28gdGhleSBjYW5ub3QgcmVhY3QgYWdhaW4KICAgIGxlZnQucmlnaHRGcmVlID0gZmFsc2U7CiAgICByaWdodC5sZWZ0RnJlZSA9IGZhbHNlOwoKICAgIC8vIHNsaWdodGx5IGRpbSB0aGUgbmVhcmJ5IEggdG8gaW5kaWNhdGUgYm9uZGluZyAobm9uLWRlc3RydWN0aXZlKQogICAgY29uc3QgbGVmdEggPSBsZWZ0LmVsLnF1ZXJ5U2VsZWN0b3IoJy5zaWRlLWgnKTsKICAgIGNvbnN0IHJpZ2h0SCA9IHJpZ2h0LmVsLnF1ZXJ5U2VsZWN0b3IoJy5zaWRlLWgnKTsKICAgIGlmIChsZWZ0SCkgbGVmdEguc3R5bGUub3BhY2l0eSA9ICcwLjYnOwogICAgaWYgKHJpZ2h0SCkgcmlnaHRILnN0eWxlLm9wYWNpdHkgPSAnMC42JzsKCiAgICAvLyBhZnRlciBhIHNob3J0IGRlbGF5IGNyZWF0ZSB0aGUgcGVwdGlkZSBib25kIHZpc3VhbHMgYW5kIGEgd2F0ZXIgbW9sZWN1bGUKICAgIHNldFRpbWVvdXQoKCk9PnsKICAgICAgY29uc3QgeDEgPSBsZWZ0LnBvcy54ICsgQ0FSRF9XOwogICAgICBjb25zdCB5MSA9IGxlZnQucG9zLnkgKyBDQVJEX0gvMjsKICAgICAgY29uc3QgeDIgPSByaWdodC5wb3MueDsKICAgICAgY29uc3QgeTIgPSByaWdodC5wb3MueSArIENBUkRfSC8yOwoKICAgICAgY29uc3QgbGluZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUygnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnLCdsaW5lJyk7CiAgICAgIGxpbmUuc2V0QXR0cmlidXRlKCd4MScsIHgxKTsKICAgICAgbGluZS5zZXRBdHRyaWJ1dGUoJ3kxJywgeTEpOwogICAgICBsaW5lLnNldEF0dHJpYnV0ZSgneDInLCB4Mik7CiAgICAgIGxpbmUuc2V0QXR0cmlidXRlKCd5MicsIHkyKTsKICAgICAgbGluZS5zZXRBdHRyaWJ1dGUoJ3N0cm9rZS13aWR0aCcsIDYpOwogICAgICBsaW5lLnNldEF0dHJpYnV0ZSgnc3Ryb2tlJywgJyMxNmEzNGEnKTsKICAgICAgbGluZS5zZXRBdHRyaWJ1dGUoJ3N0cm9rZS1saW5lY2FwJywncm91bmQnKTsKICAgICAgc3ZnLmFwcGVuZENoaWxkKGxpbmUpOwoKICAgICAgY29uc3QgbXggPSAoeDEgKyB4MikvMiwgbXkgPSAoeTEgKyB5MikvMjsKICAgICAgY29uc3QgcmVjdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUygnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnLCdyZWN0Jyk7CiAgICAgIHJlY3Quc2V0QXR0cmlidXRlKCd4JywgbXgtNDIpOwogICAgICByZWN0LnNldEF0dHJpYnV0ZSgneScsIG15LTE2KTsKICAgICAgcmVjdC5zZXRBdHRyaWJ1dGUoJ3dpZHRoJywgODQpOwogICAgICByZWN0LnNldEF0dHJpYnV0ZSgnaGVpZ2h0JywgMjgpOwogICAgICByZWN0LnNldEF0dHJpYnV0ZSgncngnLCA2KTsKICAgICAgcmVjdC5zZXRBdHRyaWJ1dGUoJ2ZpbGwnLCAnI2Y1OWUwYicpOwogICAgICBzdmcuYXBwZW5kQ2hpbGQocmVjdCk7CgogICAgICBjb25zdCB0eHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoJ2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJywndGV4dCcpOwogICAgICB0eHQuc2V0QXR0cmlidXRlKCd4JywgbXgpOwogICAgICB0eHQuc2V0QXR0cmlidXRlKCd5JywgbXkrNik7CiAgICAgIHR4dC5zZXRBdHRyaWJ1dGUoJ3RleHQtYW5jaG9yJywnbWlkZGxlJyk7CiAgICAgIHR4dC5zZXRBdHRyaWJ1dGUoJ2ZvbnQtc2l6ZScsJzEyJyk7CiAgICAgIHR4dC5zZXRBdHRyaWJ1dGUoJ2ZvbnQtd2VpZ2h0JywnNzAwJyk7CiAgICAgIHR4dC5zZXRBdHRyaWJ1dGUoJ2ZpbGwnLCcjZmZmJyk7CiAgICAgIHR4dC50ZXh0Q29udGVudD0nLU5ILUNPLSc7CiAgICAgIHN2Zy5hcHBlbmRDaGlsZCh0eHQpOwoKICAgICAgLy8gc3RvcmUgYm9uZCBpbmZvIGZvciBmdXR1cmUgcmVmZXJlbmNlIChhbmQgcG90ZW50aWFsIGJyZWFrKQogICAgICBib25kcy5wdXNoKHtsZWZ0SWQscmlnaHRJZCxsaW5lLHJlY3QsdHh0fSk7CgogICAgICAvLyBjcmVhdGUgYSBwZXJzaXN0ZW50IHdhdGVyIG1vbGVjdWxlIHNsaWdodGx5IGFib3ZlIHRoZSBib25kIChzbyBpdCBkb2Vzbid0IG92ZXJsYXApCiAgICAgIGNyZWF0ZVdhdGVyKG14LTI4LCBteS00MCk7CiAgICAgIHJlZnJlc2hCb25kcygpOwogICAgfSwgNDIwKTsKICB9CgpmdW5jdGlvbiBjcmVhdGVXYXRlcih4LHkpewogICAgY29uc3QgaWQgPSAndycgKyBEYXRlLm5vdygpOwogICAgY29uc3QgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGVsLmNsYXNzTmFtZSA9ICd3YXRlcic7CiAgICBlbC5zdHlsZS5sZWZ0ID0gKHgpICsgJ3B4JzsKICAgIGVsLnN0eWxlLnRvcCA9ICh5KSArICdweCc7IC8vIHBsYWNlZCBhYm92ZSBib25kIGJ5IGNhbGxlcgogICAgZWwuaW5uZXJUZXh0ID0gJ0jigoJPJzsKICAgIGVsLmRhdGFzZXQuaWQgPSBpZDsKICAgIGJvYXJkLmFwcGVuZENoaWxkKGVsKTsKICAgIHdhdGVycy5wdXNoKHtpZCxlbCxjcmVhdGVkQXQ6RGF0ZS5ub3coKX0pOwoKICAgIC8vIG1ha2Ugd2F0ZXIgZHJhZ2dhYmxlOiBwb2ludGVyZG93biBvbiB0aGUgd2F0ZXIgZ3JhYnMgaXQKICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJkb3duJywgKGV2dCk9PnsKICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICBlbC5zZXRQb2ludGVyQ2FwdHVyZShldnQucG9pbnRlcklkKTsKICAgICAgY29uc3QgcmVjdCA9IGJvYXJkLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICBjb25zdCBveCA9IGV2dC5jbGllbnRYIC0gcmVjdC5sZWZ0IC0gcGFyc2VGbG9hdChlbC5zdHlsZS5sZWZ0IHx8IDApOwogICAgICBjb25zdCBveSA9IGV2dC5jbGllbnRZIC0gcmVjdC50b3AgLSBwYXJzZUZsb2F0KGVsLnN0eWxlLnRvcCB8fCAwKTsKICAgICAgLy8gc3RvcmUgYXMgZHJhZ1dhdGVyCiAgICAgIGRyYWdXYXRlciA9IHsgaWQsIG94LCBveSwgcG9pbnRlcklkOiBldnQucG9pbnRlcklkLCBlbCB9OwogICAgICBlbC5jbGFzc0xpc3QuYWRkKCdkcmFnZ2luZycpOwogICAgfSk7CgogICAgLy8gY2xpY2tpbmcgc3RpbGwgY2FuIHJlbW92ZSBpZiB1c2VyIHdhbnRzIChhbHRlcm5hdGl2ZSkKICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2RibGNsaWNrJywgKCk9PnsgcmVtb3ZlV2F0ZXIoaWQpOyB9KTsKICB9CmZ1bmN0aW9uIHJlbW92ZVdhdGVyKGlkKXsKICAgIGNvbnN0IGlkeCA9IHdhdGVycy5maW5kSW5kZXgodz0+dy5pZD09PWlkKTsKICAgIGlmIChpZHg+PTApewogICAgICBjb25zdCBlbCA9IHdhdGVyc1tpZHhdLmVsOwogICAgICBlbC5zdHlsZS50cmFuc2l0aW9uPSdvcGFjaXR5IC4yNXMnOyBlbC5zdHlsZS5vcGFjaXR5PScwJzsKICAgICAgc2V0VGltZW91dCgoKT0+eyBpZiAoZWwucGFyZW50Tm9kZSkgZWwucmVtb3ZlKCk7IH0sIDI2MCk7CiAgICAgIHdhdGVycy5zcGxpY2UoaWR4LDEpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVmcmVzaEJvbmRzKCl7CiAgICAvLyB1cGRhdGUgc3ZnIGNvb3JkaW5hdGVzIGZvciBhbGwgYm9uZHMKICAgIGJvbmRzLmZvckVhY2goYj0+ewogICAgICBjb25zdCBsZWZ0ID0gYW1pbm9MaXN0LmZpbmQoYT0+YS5pZD09PWIubGVmdElkKTsKICAgICAgY29uc3QgcmlnaHQgPSBhbWlub0xpc3QuZmluZChhPT5hLmlkPT09Yi5yaWdodElkKTsKICAgICAgaWYgKCFsZWZ0IHx8ICFyaWdodCkgcmV0dXJuOwogICAgICBjb25zdCB4MSA9IGxlZnQucG9zLnggKyBDQVJEX1c7CiAgICAgIGNvbnN0IHkxID0gbGVmdC5wb3MueSArIENBUkRfSC8yOwogICAgICBjb25zdCB4MiA9IHJpZ2h0LnBvcy54OwogICAgICBjb25zdCB5MiA9IHJpZ2h0LnBvcy55ICsgQ0FSRF9ILzI7CiAgICAgIGIubGluZS5zZXRBdHRyaWJ1dGUoJ3gxJyx4MSk7IGIubGluZS5zZXRBdHRyaWJ1dGUoJ3kxJyx5MSk7CiAgICAgIGIubGluZS5zZXRBdHRyaWJ1dGUoJ3gyJyx4Mik7IGIubGluZS5zZXRBdHRyaWJ1dGUoJ3kyJyx5Mik7CiAgICAgIGNvbnN0IG14PSh4MSt4MikvMiwgbXk9KHkxK3kyKS8yOwogICAgICBiLnJlY3Quc2V0QXR0cmlidXRlKCd4JywgbXgtNDIpOyBiLnJlY3Quc2V0QXR0cmlidXRlKCd5JywgbXktMTYpOwogICAgICBiLnR4dC5zZXRBdHRyaWJ1dGUoJ3gnLCBteCk7IGIudHh0LnNldEF0dHJpYnV0ZSgneScsIG15KzYpOwogICAgfSk7CiAgfQoKICAvLyBzbWFsbCByZXNldAogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXNldCcpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCk9PnsKICAgIC8vIGNsZWFyIHN2ZwogICAgd2hpbGUoc3ZnLmZpcnN0Q2hpbGQpIHN2Zy5yZW1vdmVDaGlsZChzdmcuZmlyc3RDaGlsZCk7CiAgICAvLyByZW1vdmUgd2F0ZXJzCiAgICB3YXRlcnMuZm9yRWFjaCh3PT53LmVsLnJlbW92ZSgpKTsKICAgIHdhdGVycy5sZW5ndGggPSAwOwogICAgLy8gcmVzdG9yZSBncm91cHMgYW5kIHBvc2l0aW9ucwogICAgYW1pbm9MaXN0LmZvckVhY2goKGEsaSk9PnsKICAgICAgY29uc3QgcCA9IHJhbmRQb3MoaSk7CiAgICAgIGEucG9zID0gey4uLnB9OwogICAgICBhLmVsLnN0eWxlLmxlZnQgPSBwLnggKyAncHgnOyBhLmVsLnN0eWxlLnRvcCA9IHAueSArICdweCc7CiAgICAgIC8vIHJlc3RvcmUgcGVyLXNpZGUgYXZhaWxhYmlsaXR5CiAgICAgIGEubGVmdEZyZWUgPSB0cnVlOyBhLnJpZ2h0RnJlZSA9IHRydWU7CiAgICAgIGNvbnN0IGcxID0gYS5lbC5xdWVyeVNlbGVjdG9yKCcuYW1pbm8nKTsgY29uc3QgZzIgPSBhLmVsLnF1ZXJ5U2VsZWN0b3IoJy5jYXJib3gnKTsgY29uc3QgaCA9IGEuZWwucXVlcnlTZWxlY3RvcignLnNpZGUtaCcpOwogICAgICBpZiAoZzEpIHsgZzEuc3R5bGUub3BhY2l0eSA9ICcxJzsgfQogICAgICBpZiAoZzIpIHsgZzIuc3R5bGUub3BhY2l0eSA9ICcxJzsgfQogICAgICBpZiAoaCkgeyBoLnN0eWxlLm9wYWNpdHkgPSAnMSc7IH0KICAgIH0pOwogICAgLy8gcmVtb3ZlIGJvbmRzIGFycmF5IGFuZCByZWNyZWF0ZSAobm8gdmlzdWFscykKICAgIGJvbmRzLnNwbGljZSgwLCBib25kcy5sZW5ndGgpOwogIH0pOwoKICAvLyBwb2ludGVyIGNhcHR1cmUgcmVsZWFzZSBzYWZldHkKICBib2FyZC5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVyY2FuY2VsJywgKCk9PnsgaWYgKGRyYWcpeyBjb25zdCBlbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYC5hYVtkYXRhLWlkPSIke2RyYWcuaWR9Il1gKTsgaWYoZWwpIGVsLmNsYXNzTGlzdC5yZW1vdmUoJ2RyYWdnaW5nJyk7IGRyYWc9bnVsbDsgfSB9KTsKfSkoKTsKPC9zY3JpcHQ+CjwvYm9keT4KPC9odG1sPgo="></iframe>
</div></section>

<section id="tab-dna" class="tab"><div class="panel">
  <!-- 使用 iframe 嵌入 DNA 交互页面。srcdoc 为 base64 解码后的 HTML。 -->
  <iframe class="embed" srcdoc="data:text/html;base64,PCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9InpoLUNOIj4KPGhlYWQ+CjxtZXRhIGNoYXJzZXQ9InV0Zi04IiAvPgo8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLGluaXRpYWwtc2NhbGU9MSIgLz4KPHRpdGxlPkROQSDlkIjmiJA8L3RpdGxlPgo8c3R5bGU+CiAgOnJvb3R7IC0tYmc6I2Y4ZmFmYzsgLS1pbms6IzBmMTcyYTsgLS1ib2FyZDojZmZmZmZmOyB9CiAgKntib3gtc2l6aW5nOmJvcmRlci1ib3h9CiAgYm9keXtmb250LWZhbWlseTpzeXN0ZW0tdWksU2Vnb2UgVUksSGVsdmV0aWNhLEFyaWFsOyBtYXJnaW46MThweDsgYmFja2dyb3VuZDp2YXIoLS1iZyk7IGNvbG9yOnZhcigtLWluayk7fSAgCiAgaDF7Zm9udC1zaXplOjIwcHg7IG1hcmdpbjowIDAgOHB4O30KICAuaGludHttYXJnaW46NnB4IDAgMTJweDsgY29sb3I6IzMzNDE1NTsgZm9udC1zaXplOjEzcHg7fQogIC5ib2FyZHtwb3NpdGlvbjpyZWxhdGl2ZTsgd2lkdGg6MTAwJTsgaGVpZ2h0OjcyMHB4OyBiYWNrZ3JvdW5kOnZhcigtLWJvYXJkKTsgYm9yZGVyOjFweCBzb2xpZCAjZTZlZGYzOyBib3JkZXItcmFkaXVzOjEwcHg7IG92ZXJmbG93OmhpZGRlbjt9CiAgLnBhbGV0dGV7cG9zaXRpb246YWJzb2x1dGU7IGxlZnQ6MDsgcmlnaHQ6MDsgdG9wOjA7IG1pbi1oZWlnaHQ6MTY4cHg7IGJhY2tncm91bmQ6I2YxZjVmOTsgYm9yZGVyLWJvdHRvbToxcHggZGFzaGVkICNjYmQ1ZTE7IHBhZGRpbmc6MTBweCAxNHB4O30KICAucGFsLWdyaWR7ZGlzcGxheTpncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IHJlcGVhdCg4LCAxOTBweCk7IGdhcDoxMnB4OyBvdmVyZmxvdy14OmF1dG87IHBhZGRpbmctYm90dG9tOjZweDt9CiAgLmxlZ2VuZHttYXJnaW4tdG9wOjZweDsgZm9udC1zaXplOjEycHg7IGNvbG9yOiM0NzU1Njk7IGRpc3BsYXk6ZmxleDsgZ2FwOjE2cHg7IGFsaWduLWl0ZW1zOmNlbnRlcjt9CiAgLnNtYWxsLWJ0bnttYXJnaW46MTBweCA4cHggMCAwOyBwYWRkaW5nOjZweCAxMHB4OyBib3JkZXItcmFkaXVzOjZweDsgYm9yZGVyOjFweCBzb2xpZCAjY2JkNWUxOyBiYWNrZ3JvdW5kOiNmZmY7IGN1cnNvcjpwb2ludGVyOyBmb250LXNpemU6MTJweDt9CgogIC8qID09PSDml6DlpJbmoYbmoLjoi7fphbggPT09ICovCiAgLm51Y3sgcG9zaXRpb246YWJzb2x1dGU7IHdpZHRoOjE5MHB4OyBoZWlnaHQ6MTMycHg7IGN1cnNvcjpncmFiOyB1c2VyLXNlbGVjdDpub25lOyB0b3VjaC1hY3Rpb246bm9uZTsgfQogIC5udWMuZHJhZ2dpbmd7IHRyYW5zZm9ybTpzY2FsZSgxLjA0KTsgei1pbmRleDoyMDAwOyBjdXJzb3I6Z3JhYmJpbmc7IH0KICAvKiDkupTnorPns5blm7rlrprlnKjkuK3pl7QgKi8KICAubnVjIC5zdWdhcnsgcG9zaXRpb246YWJzb2x1dGU7IHdpZHRoOjcycHg7IGhlaWdodDo3MnB4OyB0b3A6MzRweDsgbGVmdDpjYWxjKDUwJSAtIDM2cHgpOyBiYWNrZ3JvdW5kOiNmZGU2OGE7IGJvcmRlcjoycHggc29saWQgI2I0NTMwOTsgYm9yZGVyLXJhZGl1czo4cHg7IGNsaXAtcGF0aDogcG9seWdvbig1MCUgMCUsIDEwMCUgMzYlLCA4MiUgMTAwJSwgMTglIDEwMCUsIDAgMzYlKTsgfQogIC8qIOejt+mFuO+8mlIg5Zyo5bem77ybTCDlnKjlj7MgKi8KICAubnVjIC5waG9zeyBwb3NpdGlvbjphYnNvbHV0ZTsgd2lkdGg6NDJweDsgaGVpZ2h0OjQycHg7IHRvcDoxNnB4OyBib3JkZXItcmFkaXVzOjUwJTsgYmFja2dyb3VuZDojZmVlMmUyOyBib3JkZXI6MnB4IHNvbGlkICNlZjQ0NDQ7IGNvbG9yOiM5OTFiMWI7IGRpc3BsYXk6ZmxleDsgYWxpZ24taXRlbXM6Y2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyOyBmb250LXdlaWdodDo5MDA7IH0KICAub3JpZW50LVIgLnBob3N7IGxlZnQ6MTBweDsgfSAgLm9yaWVudC1MIC5waG9zeyByaWdodDoxMHB4OyB9CiAgLyog56uv5Y+j77ya55SxIEpTIOiuoeeul+eyvuWHhuS9jee9ruOAgui/memHjOS7heWumuS5ieWfuuacrOW9ouaAgSAqLwogIC5wb3J0eyBwb3NpdGlvbjphYnNvbHV0ZTsgd2lkdGg6MTZweDsgaGVpZ2h0OjE2cHg7IGJvcmRlci1yYWRpdXM6NTAlOyBiYWNrZ3JvdW5kOiNmZmY7IGJvcmRlcjoycHggc29saWQgIzBlYTVlOTsgfQogIC5wb3J0OjphZnRlcntjb250ZW50OicnOyBwb3NpdGlvbjphYnNvbHV0ZTsgbGVmdDo1MCU7IHRvcDo1MCU7IHRyYW5zZm9ybTp0cmFuc2xhdGUoLTUwJSwtNTAlKTsgd2lkdGg6NnB4OyBoZWlnaHQ6NnB4OyBib3JkZXItcmFkaXVzOjUwJTsgYmFja2dyb3VuZDpjdXJyZW50Q29sb3I7IG9wYWNpdHk6LjZ9CiAgLmxibHsgcG9zaXRpb246YWJzb2x1dGU7IGZvbnQtc2l6ZToxMHB4OyBjb2xvcjojNDc1NTY5OyBiYWNrZ3JvdW5kOiNmMWY1Zjk7IGJvcmRlcjoxcHggc29saWQgI2NiZDVlMTsgYm9yZGVyLXJhZGl1czo2cHg7IHBhZGRpbmc6MnB4IDRweDt9CiAgLm9yaWVudC1SIC5sYmwucHtsZWZ0OjEycHg7IHRvcDotOHB4O30gLm9yaWVudC1SIC5sYmwuc3tsZWZ0OmNhbGMoNTAlIC0gMjZweCk7IHRvcDoxOHB4O30KICAub3JpZW50LUwgLmxibC5we3JpZ2h0OjEycHg7IHRvcDotOHB4O30gLm9yaWVudC1MIC5sYmwuc3tsZWZ0OmNhbGMoNTAlIC0gMjZweCk7IHRvcDoxOHB4O30KCiAgLyog56Kx5Z+677ya5pu056qE77yINjjDlzI477yJ77yMcGFsZXR0ZSDkv53mjIHov5Hns5bvvJvnlLvluIPlhYvpmobml7bnlLEgSlMg5aSW56e777yIwrEyMDBweO+8iSAqLwogIC5iYXNleyBwb3NpdGlvbjphYnNvbHV0ZTsgdG9wOjY0cHg7IHdpZHRoOjY4cHg7IGhlaWdodDoyOHB4OyBib3JkZXItcmFkaXVzOjZweDsgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGp1c3RpZnktY29udGVudDpjZW50ZXI7IGZvbnQtd2VpZ2h0OjkwMDsgY29sb3I6I2ZmZjsgfQogIC5vcmllbnQtUiAuYmFzZXsgbGVmdDphdXRvOyByaWdodDoxMHB4OyB9CiAgLm9yaWVudC1MIC5iYXNleyBsZWZ0OjEwcHg7IHJpZ2h0OmF1dG87IH0KICAuQXsgYmFja2dyb3VuZDojMDZiNmQ0OyB9IC5UeyBiYWNrZ3JvdW5kOiMxMGI5ODE7IH0gLkN7IGJhY2tncm91bmQ6I2VmNDQ0NDsgfSAuR3sgYmFja2dyb3VuZDojZWFiMzA4OyBjb2xvcjojMTExODI3O30KCiAgLyog56Kx5Z+65o6l5Y+j77ya5Ye4ID0g5a6e5b+D77yb5Ye5ID0g56m65b+D55m95bqV6buR6L65ICovCiAgLyog5ZyG5b2iICovCiAgLmJhc2VbZGF0YS1zaGFwZT0nY2lyY2xlJ11bZGF0YS1zaWRlPSdyaWdodCddW2RhdGEtc2V4PSdwZWcnXTo6YWZ0ZXIsCiAgLmJhc2VbZGF0YS1zaGFwZT0nY2lyY2xlJ11bZGF0YS1zaWRlPSdsZWZ0J11bZGF0YS1zZXg9J3BlZyddOjpiZWZvcmV7CiAgICBjb250ZW50OicnOyBwb3NpdGlvbjphYnNvbHV0ZTsgdG9wOjUwJTsgdHJhbnNmb3JtOnRyYW5zbGF0ZVkoLTUwJSk7IHdpZHRoOjE2cHg7IGhlaWdodDoxNnB4OyBib3JkZXItcmFkaXVzOjUwJTsgYmFja2dyb3VuZDojMTExODI3OyBvcGFjaXR5Oi45OwogIH0KICAuYmFzZVtkYXRhLXNoYXBlPSdjaXJjbGUnXVtkYXRhLXNpZGU9J3JpZ2h0J11bZGF0YS1zZXg9J3BlZyddOjphZnRlcnsgcmlnaHQ6LTEwcHg7IH0KICAuYmFzZVtkYXRhLXNoYXBlPSdjaXJjbGUnXVtkYXRhLXNpZGU9J2xlZnQnXVtkYXRhLXNleD0ncGVnJ106OmJlZm9yZXsgbGVmdDotMTBweDsgfQogIC5iYXNlW2RhdGEtc2hhcGU9J2NpcmNsZSddW2RhdGEtc2lkZT0ncmlnaHQnXVtkYXRhLXNleD0nc29ja2V0J106OmFmdGVyLAogIC5iYXNlW2RhdGEtc2hhcGU9J2NpcmNsZSddW2RhdGEtc2lkZT0nbGVmdCddW2RhdGEtc2V4PSdzb2NrZXQnXTo6YmVmb3JlewogICAgY29udGVudDonJzsgcG9zaXRpb246YWJzb2x1dGU7IHRvcDo1MCU7IHRyYW5zZm9ybTp0cmFuc2xhdGVZKC01MCUpOyB3aWR0aDoxNnB4OyBoZWlnaHQ6MTZweDsgYm9yZGVyLXJhZGl1czo1MCU7IGJhY2tncm91bmQ6I2ZmZjsgYm94LXNoYWRvdzowIDAgMCAycHggIzExMTgyNyBpbnNldDsKICB9CiAgLmJhc2VbZGF0YS1zaGFwZT0nY2lyY2xlJ11bZGF0YS1zaWRlPSdyaWdodCddW2RhdGEtc2V4PSdzb2NrZXQnXTo6YWZ0ZXJ7IHJpZ2h0Oi0xMHB4OyB9CiAgLmJhc2VbZGF0YS1zaGFwZT0nY2lyY2xlJ11bZGF0YS1zaWRlPSdsZWZ0J11bZGF0YS1zZXg9J3NvY2tldCddOjpiZWZvcmV7IGxlZnQ6LTEwcHg7IH0KCiAgLyog5LiJ6KeSICovCiAgLmJhc2VbZGF0YS1zaGFwZT0ndHJpJ11bZGF0YS1zaWRlPSdyaWdodCddW2RhdGEtc2V4PSdwZWcnXTo6YWZ0ZXJ7IGNvbnRlbnQ6Jyc7IHBvc2l0aW9uOmFic29sdXRlOyByaWdodDotMTJweDsgdG9wOjUwJTsgdHJhbnNmb3JtOnRyYW5zbGF0ZVkoLTUwJSk7IHdpZHRoOjA7IGhlaWdodDowOyBib3JkZXItbGVmdDoxOHB4IHNvbGlkICMxMTE4Mjc7IGJvcmRlci10b3A6OXB4IHNvbGlkIHRyYW5zcGFyZW50OyBib3JkZXItYm90dG9tOjlweCBzb2xpZCB0cmFuc3BhcmVudDsgfQogIC5iYXNlW2RhdGEtc2hhcGU9J3RyaSddW2RhdGEtc2lkZT0nbGVmdCddW2RhdGEtc2V4PSdwZWcnXTo6YmVmb3JleyBjb250ZW50OicnOyBwb3NpdGlvbjphYnNvbHV0ZTsgbGVmdDotMTJweDsgIHRvcDo1MCU7IHRyYW5zZm9ybTp0cmFuc2xhdGVZKC01MCUpOyB3aWR0aDowOyBoZWlnaHQ6MDsgYm9yZGVyLXJpZ2h0OjE4cHggc29saWQgIzExMTgyNzsgYm9yZGVyLXRvcDo5cHggc29saWQgdHJhbnNwYXJlbnQ7IGJvcmRlci1ib3R0b206OXB4IHNvbGlkIHRyYW5zcGFyZW50OyB9CiAgLmJhc2VbZGF0YS1zaGFwZT0ndHJpJ11bZGF0YS1zaWRlPSdyaWdodCddW2RhdGEtc2V4PSdzb2NrZXQnXTo6YWZ0ZXJ7IGNvbnRlbnQ6Jyc7IHBvc2l0aW9uOmFic29sdXRlOyByaWdodDotMTJweDsgdG9wOjUwJTsgdHJhbnNmb3JtOnRyYW5zbGF0ZVkoLTUwJSk7IHdpZHRoOjE4cHg7IGhlaWdodDoxOHB4OyBiYWNrZ3JvdW5kOiNmZmY7IGNsaXAtcGF0aDogcG9seWdvbigwIDAsIDEwMCUgNTAlLCAwIDEwMCUpOyBib3gtc2hhZG93OjAgMCAwIDJweCAjMTExODI3IGluc2V0OyB9CiAgLmJhc2VbZGF0YS1zaGFwZT0ndHJpJ11bZGF0YS1zaWRlPSdsZWZ0J11bZGF0YS1zZXg9J3NvY2tldCddOjpiZWZvcmV7IGNvbnRlbnQ6Jyc7IHBvc2l0aW9uOmFic29sdXRlOyBsZWZ0Oi0xMnB4OyAgdG9wOjUwJTsgdHJhbnNmb3JtOnRyYW5zbGF0ZVkoLTUwJSk7IHdpZHRoOjE4cHg7IGhlaWdodDoxOHB4OyBiYWNrZ3JvdW5kOiNmZmY7IGNsaXAtcGF0aDogcG9seWdvbigxMDAlIDAsIDAgNTAlLCAxMDAlIDEwMCUpOyBib3gtc2hhZG93OjAgMCAwIDJweCAjMTExODI3IGluc2V0OyB9CgogIC8qIOeUu+W4g+WxgiBTVkcg5LiO5Y2V5YWD5YaFIFNWRyAqLwogIHN2Z3sgcG9zaXRpb246YWJzb2x1dGU7IGxlZnQ6MDsgdG9wOjA7IHdpZHRoOjEwMCU7IGhlaWdodDoxMDAlOyBwb2ludGVyLWV2ZW50czpub25lOyB9CiAgLmludHJheyBwb3NpdGlvbjphYnNvbHV0ZTsgbGVmdDowOyB0b3A6MDsgd2lkdGg6MTkwcHg7IGhlaWdodDoxMzJweDsgcG9pbnRlci1ldmVudHM6bm9uZTsgb3ZlcmZsb3c6dmlzaWJsZTsgfQoKICAud2F0ZXJ7IHBvc2l0aW9uOmFic29sdXRlOyBwYWRkaW5nOjZweCAxMHB4OyBib3JkZXItcmFkaXVzOjZweDsgYmFja2dyb3VuZDpyZ2JhKDU5LDEzMCwyNDYsLjEyKTsgYm9yZGVyOjFweCBzb2xpZCByZ2JhKDU5LDEzMCwyNDYsLjMyKTsgZGlzcGxheTpmbGV4OyBhbGlnbi1pdGVtczpjZW50ZXI7IGp1c3RpZnktY29udGVudDpjZW50ZXI7IGZvbnQtd2VpZ2h0OjgwMDsgY29sb3I6IzAzNjlhMTsgdXNlci1zZWxlY3Q6bm9uZTsgY3Vyc29yOnBvaW50ZXI7IH0KPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KICA8aDE+RE5BIOWPjOmTvueahOWQiOaIkDwvaDE+CiAgPHAgY2xhc3M9ImhpbnQiPui/nuaOpeaWueW8j++8muezluKAlOeiseWfuui/nue6v+S+neeEtuS7jjxiPuezlueahOS4iuinkumhtueCuTwvYj7vvIhSOiDlj7PkuIrvvJtMOiDlt6bkuIrvvInov57liLA8Yj7norHln7rpnaDns5bkuIDkvqfnmoTovrnnvJg8L2I+77ybPC9wPgoKICA8ZGl2IGNsYXNzPSJib2FyZCIgaWQ9ImJvYXJkIj4KICAgIDxkaXYgY2xhc3M9InBhbGV0dGUiPgogICAgICA8ZGl2IGNsYXNzPSJwYWwtZ3JpZCIgaWQ9InBhbGdyaWQiPjwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJsZWdlbmQiPjxzcGFuPuS7jui/memHjOaLluaLvSA9IOWkjeWItuS4gOS4qjwvc3Bhbj48YnV0dG9uIGNsYXNzPSJzbWFsbC1idG4iIGlkPSJyZXNldCI+6YeN572u55S75biDPC9idXR0b24+PC9kaXY+CiAgICA8L2Rpdj4KICAgIDxzdmcgaWQ9InN2ZyI+PC9zdmc+CiAgPC9kaXY+Cgo8c2NyaXB0PgooZnVuY3Rpb24oKXsKICBjb25zdCBib2FyZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdib2FyZCcpOwogIGNvbnN0IHN2ZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdmcnKTsKICBjb25zdCBwYWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFsZ3JpZCcpOwogIGNvbnN0IGl0ZW1zPVtdLCBib25kcz1bXSwgd2F0ZXJzPVtdLCBwYWlycz1bXTsKICBjb25zdCBDQVJEX1c9MTkwLCBDQVJEX0g9MTMyOwoKICAvLyDlm5vnorHln7ogw5cgMiDnnJ/plZzlg48KICBjb25zdCB2ID0gKGJhc2Usc2hhcGUsc2V4KSA9PiAoWwogICAge2Jhc2UsIHNoYXBlLCBzZXgsIG9yaWVudDonUicsIHNpZGU6J3JpZ2h0JywgdGl0bGU6YCR7YmFzZX0gwrcg5Y+z5ZCRIChQ4oaSU+KGkkIpYH0sCiAgICB7YmFzZSwgc2hhcGUsIHNleCwgb3JpZW50OidMJywgc2lkZTonbGVmdCcsICB0aXRsZTpgJHtiYXNlfSDCtyDlt6blkJEgKELihpJT4oaSUClgfQogIF0pOwogIGNvbnN0IHZhcmlhbnRzID0gWwogICAgLi4udignQScsJ2NpcmNsZScsJ3BlZycpLAogICAgLi4udignVCcsJ2NpcmNsZScsJ3NvY2tldCcpLAogICAgLi4udignQycsJ3RyaScsJ3BlZycpLAogICAgLi4udignRycsJ3RyaScsJ3NvY2tldCcpCiAgXTsKCiAgZnVuY3Rpb24gbWFrZU51YyhjZmcpewogICAgY29uc3QgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsgZWwuY2xhc3NOYW1lPSdudWMgb3JpZW50LScrY2ZnLm9yaWVudDsgZWwuZGF0YXNldC5iYXNlPWNmZy5iYXNlOyBlbC50aXRsZT1jZmcudGl0bGU7CiAgICBlbC5pbm5lckhUTUwgPSBgCiAgICAgIDxkaXYgY2xhc3M9InBob3MiPlA8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0icG9ydCBwNSIgZGF0YS1wb3J0PSJwNSIgdGl0bGU9IjUnLVAiPjwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJzdWdhciIgdGl0bGU9IuS6lOeis+ezliI+PC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InBvcnQgb2giIGRhdGEtcG9ydD0ib2giIHRpdGxlPSIzJy1PSCI+PC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9ImxibCBwIj41JzwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJsYmwgcyI+Myc8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0iYmFzZSAke2NmZy5iYXNlfSIgZGF0YS1zaGFwZT0iJHtjZmcuc2hhcGV9IiBkYXRhLXNleD0iJHtjZmcuc2V4fSIgZGF0YS1zaWRlPSIke2NmZy5zaWRlfSI+JHtjZmcuYmFzZX08L2Rpdj4KICAgICAgPHN2ZyBjbGFzcz0iaW50cmEiPjwvc3ZnPmA7CiAgICByZXR1cm4gZWw7CiAgfQoKICB2YXJpYW50cy5mb3JFYWNoKGNmZz0+eyBjb25zdCBlbD1tYWtlTnVjKGNmZyk7IGVsLmRhdGFzZXQucGFsZXR0ZT0nMSc7IGVsLnN0eWxlLnBvc2l0aW9uPSdyZWxhdGl2ZSc7IHBhbC5hcHBlbmRDaGlsZChlbCk7IGxheW91dE51YyhlbCk7IH0pOwoKICBmdW5jdGlvbiBsYXlvdXROdWMoZWwpewogICAgY29uc3Qgb3JpZW50ID0gZWwuY2xhc3NMaXN0LmNvbnRhaW5zKCdvcmllbnQtTCcpID8gJ0wnIDogJ1InOwogICAgY29uc3Qgc3VnYXIgPSBlbC5xdWVyeVNlbGVjdG9yKCcuc3VnYXInKTsKICAgIGNvbnN0IHBob3MgID0gZWwucXVlcnlTZWxlY3RvcignLnBob3MnKTsKICAgIGNvbnN0IG9oICAgID0gZWwucXVlcnlTZWxlY3RvcignLnBvcnQub2gnKTsKICAgIGNvbnN0IHA1ICAgID0gZWwucXVlcnlTZWxlY3RvcignLnBvcnQucDUnKTsKICAgIGNvbnN0IGJhc2UgID0gZWwucXVlcnlTZWxlY3RvcignLmJhc2UnKTsKICAgIGNvbnN0IGludHJhID0gZWwucXVlcnlTZWxlY3Rvcignc3ZnLmludHJhJyk7CgogICAgLy8g4oCU4oCUIHBhbGV0dGUg5LiN5aSW56e777yb55S75biD5YWL6ZqG5aSW56e7IMKxMjAwcHgg4oCU4oCUCiAgICBjb25zdCBpc1BhbGV0dGUgPSBlbC5kYXRhc2V0LnBhbGV0dGU9PT0nMSc7CiAgICBpZihvcmllbnQ9PT0nUicpeyBiYXNlLnN0eWxlLnJpZ2h0ID0gaXNQYWxldHRlID8gJzEwcHgnIDogJy0xMDBweCc7IGJhc2Uuc3R5bGUubGVmdD0nYXV0byc7IH0KICAgIGVsc2UgICAgICAgICAgICB7IGJhc2Uuc3R5bGUubGVmdCAgPSBpc1BhbGV0dGUgPyAnMTBweCcgOiAnLTEwMHB4JzsgYmFzZS5zdHlsZS5yaWdodD0nYXV0byc7IH0KCiAgICBjb25zdCBzeD1zdWdhci5vZmZzZXRMZWZ0LCBzeT1zdWdhci5vZmZzZXRUb3AsIHN3PXN1Z2FyLm9mZnNldFdpZHRoLCBzaD1zdWdhci5vZmZzZXRIZWlnaHQ7CiAgICBjb25zdCB2X3RsPXt4OnN4KzAuMDAqc3csIHk6c3krMC4zNipzaH07ICAgLy8g5bem5LiKIOKJiCBDNScKICAgIGNvbnN0IHZfdHI9e3g6c3grMS4wMCpzdywgeTpzeSswLjM2KnNofTsgICAvLyDlj7PkuIrvvIjplZzlg4/vvIkKICAgIGNvbnN0IHZfbGw9e3g6c3grMC4xOCpzdywgeTpzeSsxLjAwKnNofTsgICAvLyDlt6bkuIsg4omIIEMzJwoKICAgIC8vIDMnLU9IIOerr+WPo++8muW3puS4i+inkuWklue8mAogICAgb2guc3R5bGUubGVmdD0odl9sbC54LTcpKydweCc7CiAgICBvaC5zdHlsZS50b3AgPSh2X2xsLnktNykrJ3B4JzsKCiAgICAvLyA1Jy1QIOerr+WPo++8muejt+mFuOWchumhtuS4reW/gwogICAgY29uc3QgcGh4ID0gcGhvcy5vZmZzZXRMZWZ0ICsgcGhvcy5vZmZzZXRXaWR0aC8yOwogICAgY29uc3QgcGh5ID0gcGhvcy5vZmZzZXRUb3A7IC8vIOmhtui+uQogICAgcDUuc3R5bGUubGVmdCA9IChwaHggLSA4KSArICdweCc7CiAgICBwNS5zdHlsZS50b3AgID0gKHBoeSAtIDgpICsgJ3B4JzsKCiAgICAvLyDljZXlhYPlhoXpg6jov57nur/vvJpQ4oCTUyAvIFPigJNPSCAvIFPigJNCYXNl77yI5YWo6YOo5Yiw6L6557yY77yJCiAgICBpbnRyYS5zZXRBdHRyaWJ1dGUoJ3ZpZXdCb3gnLGAwIDAgJHtDQVJEX1d9ICR7Q0FSRF9IfWApOwogICAgd2hpbGUoaW50cmEuZmlyc3RDaGlsZCkgaW50cmEucmVtb3ZlQ2hpbGQoaW50cmEuZmlyc3RDaGlsZCk7CgogICAgLy8gMSkgUOKAk1PvvJrku47lnIblkajovrnnvJjliLDns5bpobbngrnvvIhS4oaS5bem5LiK77ybTOKGkuWPs+S4iu+8iQogICAgY29uc3QgcGN4ID0gcGhvcy5vZmZzZXRMZWZ0ICsgcGhvcy5vZmZzZXRXaWR0aC8yOwogICAgY29uc3QgcGN5ID0gcGhvcy5vZmZzZXRUb3AgICsgcGhvcy5vZmZzZXRIZWlnaHQvMjsKICAgIGNvbnN0IHJjICA9IHBob3Mub2Zmc2V0V2lkdGgvMjsgLy8g5Y2K5b6ECiAgICBjb25zdCBTVG9wID0gKG9yaWVudD09PSdSJykgPyB2X3RsIDogdl90cjsKICAgIGNvbnN0IGR4MSA9IFNUb3AueCAtIHBjeCwgZHkxID0gU1RvcC55IC0gcGN5OyBjb25zdCBsZW4xID0gTWF0aC5oeXBvdChkeDEsZHkxKXx8MTsKICAgIGNvbnN0IHB4MSA9IHBjeCArIGR4MS9sZW4xKihyYy0yKTsgY29uc3QgcHkxID0gcGN5ICsgZHkxL2xlbjEqKHJjLTIpOwogICAgaW50cmEuYXBwZW5kQ2hpbGQobWFrZUxpbmUocHgxLHB5MSwgU1RvcC54LFNUb3AueSwnI2VmNDQ0NCcsMikpOwoKICAgIC8vIDIpIFMo5bem5LiLKeKAk09I77ya5LuO57OW6L656aG254K55Yiw56uv5Y+j6L6557yYCiAgICBjb25zdCBvaGM9e3g6b2gub2Zmc2V0TGVmdCs4LCB5Om9oLm9mZnNldFRvcCs4fTsKICAgIGNvbnN0IGR4Mj1vaGMueCAtIHZfbGwueCwgZHkyPW9oYy55IC0gdl9sbC55OyBjb25zdCBsZW4yPU1hdGguaHlwb3QoZHgyLGR5Mil8fDE7CiAgICBjb25zdCBveDI9b2hjLnggLSBkeDIvbGVuMio4LCBveTI9b2hjLnkgLSBkeTIvbGVuMio4OyAgIC8vIOWIsOerr+WPo+i+uee8mAogICAgaW50cmEuYXBwZW5kQ2hpbGQobWFrZUxpbmUodl9sbC54LHZfbGwueSwgb3gyLG95MiwnIzBlYTVlOScsMikpOwoKICAgIC8vIDMpIOezluKAlOeiseWfuu+8iOeBsO+8ie+8mui1t+eCuT3ns5bkuIrop5LvvIhS4oaS5Y+z5LiKIHZfdHLvvJtM4oaS5bem5LiKIHZfdGzvvInvvIznu4jngrk956Kx5Z+66Z2g57OW5L6n5aSW6L6557yYCiAgICBjb25zdCBiciA9IGJhc2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7IGNvbnN0IGVyID0gZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICBjb25zdCBiYXNlTGVmdCA9IGJyLmxlZnQgLSBlci5sZWZ0LCBiYXNlUmlnaHQgPSBici5yaWdodCAtIGVyLmxlZnQsIGJhc2VNaWRZID0gYnIudG9wIC0gZXIudG9wICsgYnIuaGVpZ2h0LzI7CiAgICBjb25zdCBiYXNlRWRnZVggPSAob3JpZW50PT09J1InKSA/IGJhc2VMZWZ0IDogYmFzZVJpZ2h0OyAvLyDotLTov5Hns5bnmoTkuIDkvqfovrnnlYwKICAgIGNvbnN0IHN1Z2FyVmVydGV4ID0gKG9yaWVudD09PSdSJykgPyB2X3RyIDogdl90bDsKICAgIGludHJhLmFwcGVuZENoaWxkKG1ha2VMaW5lKHN1Z2FyVmVydGV4LngsIHN1Z2FyVmVydGV4LnksIGJhc2VFZGdlWCwgYmFzZU1pZFksICcjNjQ3NDhiJywgMikpOwogIH0KCiAgZnVuY3Rpb24gbWFrZUxpbmUoeDEseTEseDIseTIsc3Ryb2tlLHcpeyBjb25zdCBMPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUygnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnLCdsaW5lJyk7IEwuc2V0QXR0cmlidXRlKCd4MScseDEpOyBMLnNldEF0dHJpYnV0ZSgneTEnLHkxKTsgTC5zZXRBdHRyaWJ1dGUoJ3gyJyx4Mik7IEwuc2V0QXR0cmlidXRlKCd5MicseTIpOyBMLnNldEF0dHJpYnV0ZSgnc3Ryb2tlJyxzdHJva2UpOyBMLnNldEF0dHJpYnV0ZSgnc3Ryb2tlLXdpZHRoJyx3KTsgTC5zZXRBdHRyaWJ1dGUoJ3N0cm9rZS1saW5lY2FwJywncm91bmQnKTsgcmV0dXJuIEw7IH0KCiAgLy8gPT09PT0g5ouW5ou977ya5YWL6ZqGIC8g56e75YqoID09PT09CiAgbGV0IGRyYWc9bnVsbDsKICBib2FyZC5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVyZG93bicsIChldik9PnsKICAgIGNvbnN0IGNhcmQ9ZXYudGFyZ2V0LmNsb3Nlc3QoJy5udWMnKTsgaWYoIWNhcmQpIHJldHVybjsgY29uc3QgcmVjdD1ib2FyZC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIGlmKGNhcmQuZGF0YXNldC5wYWxldHRlPT09JzEnKXsKICAgICAgY29uc3QgY2xvbmU9Y2FyZC5jbG9uZU5vZGUodHJ1ZSk7IGNsb25lLmRhdGFzZXQucGFsZXR0ZT0nMCc7IGNsb25lLnN0eWxlLnBvc2l0aW9uPSdhYnNvbHV0ZSc7CiAgICAgIGNsb25lLnN0eWxlLmxlZnQ9KGV2LmNsaWVudFgtcmVjdC5sZWZ0LUNBUkRfVy8yKSsncHgnOyBjbG9uZS5zdHlsZS50b3A9KGV2LmNsaWVudFktcmVjdC50b3AtQ0FSRF9ILzIpKydweCc7CiAgICAgIGJvYXJkLmFwcGVuZENoaWxkKGNsb25lKTsKICAgICAgY29uc3QgaWQ9J24nK01hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpOyBjbG9uZS5kYXRhc2V0LmlkPWlkOwogICAgICBsYXlvdXROdWMoY2xvbmUpOwogICAgICBjb25zdCBiYXNlRWw9Y2xvbmUucXVlcnlTZWxlY3RvcignLmJhc2UnKTsKICAgICAgY29uc3QgbWV0YT17YmFzZVR5cGU6Y2xvbmUuZGF0YXNldC5iYXNlfHxiYXNlRWwudGV4dENvbnRlbnQudHJpbSgpLCBzaGFwZTpiYXNlRWwuZGF0YXNldC5zaGFwZSwgc2V4OmJhc2VFbC5kYXRhc2V0LnNleCwgc2lkZTpiYXNlRWwuZGF0YXNldC5zaWRlLCBvcmllbnQ6Y2xvbmUuY2xhc3NMaXN0LmNvbnRhaW5zKCdvcmllbnQtTCcpPydMJzonUid9OwogICAgICBpdGVtcy5wdXNoKHtpZCwgZWw6Y2xvbmUsIHBvczp7eDpwYXJzZUZsb2F0KGNsb25lLnN0eWxlLmxlZnQpLCB5OnBhcnNlRmxvYXQoY2xvbmUuc3R5bGUudG9wKX0sIGxlZnRGcmVlOnRydWUsIHJpZ2h0RnJlZTp0cnVlLCAuLi5tZXRhfSk7CiAgICAgIGNsb25lLnNldFBvaW50ZXJDYXB0dXJlKGV2LnBvaW50ZXJJZCk7IGRyYWc9e2lkLCBveDpDQVJEX1cvMiwgb3k6Q0FSRF9ILzJ9OyBjbG9uZS5jbGFzc0xpc3QuYWRkKCdkcmFnZ2luZycpOwogICAgfWVsc2V7CiAgICAgIGNvbnN0IGlkPWNhcmQuZGF0YXNldC5pZDsgY29uc3QgaXQ9aXRlbXMuZmluZChhPT5hLmlkPT09aWQpOyBjYXJkLnNldFBvaW50ZXJDYXB0dXJlKGV2LnBvaW50ZXJJZCk7IGNvbnN0IHI9Ym9hcmQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7IGRyYWc9e2lkLCBveDpldi5jbGllbnRYLXIubGVmdC1pdC5wb3MueCwgb3k6ZXYuY2xpZW50WS1yLnRvcC1pdC5wb3MueX07IGNhcmQuY2xhc3NMaXN0LmFkZCgnZHJhZ2dpbmcnKTsKICAgIH0KICB9KTsKICBib2FyZC5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVybW92ZScsIChldik9PnsgaWYoIWRyYWcpIHJldHVybjsgY29uc3Qgcj1ib2FyZC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsgY29uc3QgaXQ9aXRlbXMuZmluZChhPT5hLmlkPT09ZHJhZy5pZCk7IGl0LnBvcy54PWV2LmNsaWVudFgtci5sZWZ0LWRyYWcub3g7IGl0LnBvcy55PWV2LmNsaWVudFktci50b3AtZHJhZy5veTsgaXQuZWwuc3R5bGUubGVmdD1pdC5wb3MueCsncHgnOyBpdC5lbC5zdHlsZS50b3A9aXQucG9zLnkrJ3B4JzsgcmVmcmVzaCgpOyB9KTsKICBib2FyZC5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVydXAnLCAoKT0+ewogICAgaWYoIWRyYWcpIHJldHVybjsgY29uc3QgZWw9ZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgLm51Y1tkYXRhLWlkPSIke2RyYWcuaWR9Il1gKTsgaWYoZWwpIGVsLmNsYXNzTGlzdC5yZW1vdmUoJ2RyYWdnaW5nJyk7IGNvbnN0IEE9aXRlbXMuZmluZChhPT5hLmlkPT09ZHJhZy5pZCk7CiAgICBmb3IoY29uc3QgQiBvZiBpdGVtcyl7IGlmKEIuaWQ9PT1BLmlkKSBjb250aW51ZTsgaWYobmVhcihnZXRQb3J0KEEsJ29oJyksZ2V0UG9ydChCLCdwNScpKSAmJiBBLnJpZ2h0RnJlZSAmJiBCLmxlZnRGcmVlICYmICFpc0JvbmQoQS5pZCxCLmlkKSl7IGZvcm1QaG9zKEEuaWQsQi5pZCk7IGJyZWFrOyB9IGlmKG5lYXIoZ2V0UG9ydChCLCdvaCcpLGdldFBvcnQoQSwncDUnKSkgJiYgQi5yaWdodEZyZWUgJiYgQS5sZWZ0RnJlZSAmJiAhaXNCb25kKEIuaWQsQS5pZCkpeyBmb3JtUGhvcyhCLmlkLEEuaWQpOyBicmVhazsgfSB9CiAgICBmb3IoY29uc3QgQiBvZiBpdGVtcyl7IGlmKEIuaWQ9PT1BLmlkKSBjb250aW51ZTsgdHJ5UGFpcihBLEIpOyB0cnlQYWlyKEIsQSk7IH0KICAgIGRyYWc9bnVsbDsKICB9KTsKCiAgLy8gPT09PT0g56uv5Y+j5LiO6YWN5a+56ZSa54K5ID09PT09CiAgZnVuY3Rpb24gZ2V0UG9ydChpdCwgd2hpY2gpeyBjb25zdCBlbD1pdC5lbC5xdWVyeVNlbGVjdG9yKHdoaWNoPT09J29oJz8nLnBvcnQub2gnOicucG9ydC5wNScpOyBjb25zdCByPWVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLCB3cj1ib2FyZC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsgcmV0dXJuIHt4OnIubGVmdCs4LXdyLmxlZnQsIHk6ci50b3ArOC13ci50b3B9OyB9CiAgZnVuY3Rpb24gbmVhcihhLGIpeyByZXR1cm4gTWF0aC5oeXBvdChhLngtYi54LGEueS1iLnkpIDwgMjI7IH0KICBmdW5jdGlvbiBiYXNlQW5jaG9yKGl0KXsgY29uc3QgYmFzZT1pdC5lbC5xdWVyeVNlbGVjdG9yKCcuYmFzZScpOyBjb25zdCBicj1iYXNlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLCB3cj1ib2FyZC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsgcmV0dXJuICggKGl0LnNpZGV8fGJhc2UuZGF0YXNldC5zaWRlKT09PSdyaWdodCcgPyB7eDpici5yaWdodC13ci5sZWZ0LCB5OmJyLnRvcCtici5oZWlnaHQvMi13ci50b3B9IDoge3g6YnIubGVmdC13ci5sZWZ0LCB5OmJyLnRvcCtici5oZWlnaHQvMi13ci50b3B9ICk7IH0KCiAgZnVuY3Rpb24gZWRnZUJldHdlZW4oYSwgYiwgcmE9OCwgcmI9OCl7IGNvbnN0IGR4PWIueC1hLngsIGR5PWIueS1hLnk7IGNvbnN0IGQ9TWF0aC5oeXBvdChkeCxkeSl8fDE7IHJldHVybiB7IHgxOmEueCArIGR4L2QqcmEsIHkxOmEueSArIGR5L2QqcmEsIHgyOmIueCAtIGR4L2QqcmIsIHkyOmIueSAtIGR5L2QqcmIgfSB9CgogIGZ1bmN0aW9uIHJlZnJlc2goKXsKICAgIGJvbmRzLmZvckVhY2goYj0+eyBjb25zdCBMPWl0ZW1zLmZpbmQoeD0+eC5pZD09PWIubCksIFI9aXRlbXMuZmluZCh4PT54LmlkPT09Yi5yKTsgY29uc3QgQT1nZXRQb3J0KEwsJ29oJyksIFA9Z2V0UG9ydChSLCdwNScpOyBjb25zdCBlPWVkZ2VCZXR3ZWVuKEEsUCwxMCwxMCk7IGIubGluZS5zZXRBdHRyaWJ1dGUoJ3gxJyxlLngxKTsgYi5saW5lLnNldEF0dHJpYnV0ZSgneTEnLGUueTEpOyBiLmxpbmUuc2V0QXR0cmlidXRlKCd4MicsZS54Mik7IGIubGluZS5zZXRBdHRyaWJ1dGUoJ3kyJyxlLnkyKTsgY29uc3QgbXg9KGUueDErZS54MikvMiwgbXk9KGUueTErZS55MikvMjsgYi5yZWN0LnNldEF0dHJpYnV0ZSgneCcsbXgtNzApOyBiLnJlY3Quc2V0QXR0cmlidXRlKCd5JyxteS0xNik7IGIudHh0LnNldEF0dHJpYnV0ZSgneCcsbXgpOyBiLnR4dC5zZXRBdHRyaWJ1dGUoJ3knLG15KzYpOyB9KTsKICAgIHBhaXJzLmZvckVhY2gocD0+eyBjb25zdCBBPWJhc2VBbmNob3IoaXRlbXMuZmluZCh4PT54LmlkPT09cC5hKSksIEI9YmFzZUFuY2hvcihpdGVtcy5maW5kKHg9PnguaWQ9PT1wLmIpKTsgcC5saW5lLnNldEF0dHJpYnV0ZSgneDEnLEEueCk7IHAubGluZS5zZXRBdHRyaWJ1dGUoJ3kxJyxBLnkpOyBwLmxpbmUuc2V0QXR0cmlidXRlKCd4MicsQi54KTsgcC5saW5lLnNldEF0dHJpYnV0ZSgneTInLEIueSk7IH0pOwogIH0KCiAgZnVuY3Rpb24gaXNCb25kKGwscil7IHJldHVybiBib25kcy5zb21lKGI9PmIubD09PWwgJiYgYi5yPT09cik7IH0KICBmdW5jdGlvbiBpc1BhaXJlZChhLGIpeyByZXR1cm4gcGFpcnMuc29tZShwPT4ocC5hPT09YSAmJiBwLmI9PT1iKXx8KHAuYT09PWIgJiYgcC5iPT09YSkpOyB9CiAgZnVuY3Rpb24gaXNDb21wbGVtZW50KGEsYil7IHJldHVybiAoYT09PSdBJyYmYj09PSdUJyl8fChhPT09J1QnJiZiPT09J0EnKXx8KGE9PT0nQycmJmI9PT0nRycpfHwoYT09PSdHJyYmYj09PSdDJyk7IH0KCiAgZnVuY3Rpb24gZm9ybVBob3MobCxyKXsKICAgIGNvbnN0IEw9aXRlbXMuZmluZChhPT5hLmlkPT09bCksIFI9aXRlbXMuZmluZChhPT5hLmlkPT09cik7IEwucmlnaHRGcmVlPWZhbHNlOyBSLmxlZnRGcmVlPWZhbHNlOwogICAgY29uc3QgQT1nZXRQb3J0KEwsJ29oJyksIFA9Z2V0UG9ydChSLCdwNScpOyBjb25zdCBlPWVkZ2VCZXR3ZWVuKEEsUCwxMCwxMCk7CiAgICBjb25zdCBsaW5lPXN2Z0xpbmUoZS54MSxlLnkxLGUueDIsZS55MiwnIzBlYTVlOScsNSk7CiAgICBjb25zdCByZWN0PXN2Z1JlY3QoKGUueDErZS54MikvMi03MCwoZS55MStlLnkyKS8yLTE2LDE0MCwyOCw2LCcjMjU2M2ViJyk7CiAgICBjb25zdCB0eHQ9c3ZnVGV4dCgoZS54MStlLngyKS8yLChlLnkxK2UueTIpLzIrNiwi56O36YW45LqM6YWv6ZSuIDUn4oaSMyciKTsKICAgIGJvbmRzLnB1c2goe2wscixsaW5lLHJlY3QsdHh0fSk7CiAgICBjb25zdCB3PW1ha2VXYXRlcigoKGUueDErZS54MikvMiktMjgsKChlLnkxK2UueTIpLzIpLTQ2KTsKICAgIHcuYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlcnVwJywoKT0+eyBjb25zdCBteD0oZS54MStlLngyKS8yLCBteT0oZS55MStlLnkyKS8yOyBjb25zdCB3eD1wYXJzZUZsb2F0KHcuc3R5bGUubGVmdCkrMTYsIHd5PXBhcnNlRmxvYXQody5zdHlsZS50b3ApKzgsIGQ9TWF0aC5oeXBvdCh3eC1teCx3eS1teSk7IGlmKGQ8NDApeyBbbGluZSxyZWN0LHR4dF0uZm9yRWFjaChlPT5lLnJlbW92ZSgpKTsgTC5yaWdodEZyZWU9dHJ1ZTsgUi5sZWZ0RnJlZT10cnVlOyBib25kcy5zcGxpY2UoYm9uZHMuZmluZEluZGV4KGI9PmIubD09PWwmJmIucj09PXIpLDEpOyB3LnJlbW92ZSgpOyB9IH0pOwogIH0KCiAgZnVuY3Rpb24gdHJ5UGFpcihhLGIpeyBjb25zdCBzaGFwZU9LPWEuc2hhcGU9PT1iLnNoYXBlOyBjb25zdCBzZXhPSz1hLnNleCE9PWIuc2V4OyBjb25zdCBmYWNlT0s9KGEuc2lkZT09PSdyaWdodCcmJmIuc2lkZT09PSdsZWZ0Jyl8fChhLnNpZGU9PT0nbGVmdCcmJmIuc2lkZT09PSdyaWdodCcpOyBpZighKHNoYXBlT0smJnNleE9LJiZmYWNlT0smJmlzQ29tcGxlbWVudChhLmJhc2VUeXBlLGIuYmFzZVR5cGUpKSkgcmV0dXJuOyBjb25zdCBBPWJhc2VBbmNob3IoYSksIEI9YmFzZUFuY2hvcihiKTsgY29uc3QgZGlzdD1NYXRoLmh5cG90KEEueC1CLngsQS55LUIueSk7IGlmKGRpc3Q8MzAgJiYgIWlzUGFpcmVkKGEuaWQsYi5pZCkpeyBjb25zdCBsaW5lPXN2Z0xpbmUoQS54LEEueSxCLngsQi55LCcjOTRhM2I4JywzKTsgbGluZS5zZXRBdHRyaWJ1dGUoJ3N0cm9rZS1kYXNoYXJyYXknLCc2IDYnKTsgcGFpcnMucHVzaCh7YTphLmlkLCBiOmIuaWQsIGxpbmV9KTsgbGluZS5hZGRFdmVudExpc3RlbmVyKCdkYmxjbGljaycsKCk9PnsgY29uc3QgaT1wYWlycy5maW5kSW5kZXgocD0+KHAuYT09PWEuaWQmJnAuYj09PWIuaWQpfHwocC5hPT09Yi5pZCYmcC5iPT09YS5pZCkpOyBpZihpPj0wKXsgcGFpcnNbaV0ubGluZS5yZW1vdmUoKTsgcGFpcnMuc3BsaWNlKGksMSk7fSB9KTsgfSB9CgogIGZ1bmN0aW9uIHN2Z0xpbmUoeDEseTEseDIseTIsc3Ryb2tlLHcpeyBjb25zdCBMPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUygnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnLCdsaW5lJyk7IEwuc2V0QXR0cmlidXRlKCd4MScseDEpOyBMLnNldEF0dHJpYnV0ZSgneTEnLHkxKTsgTC5zZXRBdHRyaWJ1dGUoJ3gyJyx4Mik7IEwuc2V0QXR0cmlidXRlKCd5MicseTIpOyBMLnNldEF0dHJpYnV0ZSgnc3Ryb2tlJyxzdHJva2UpOyBMLnNldEF0dHJpYnV0ZSgnc3Ryb2tlLXdpZHRoJyx3KTsgTC5zZXRBdHRyaWJ1dGUoJ3N0cm9rZS1saW5lY2FwJywncm91bmQnKTsgc3ZnLmFwcGVuZENoaWxkKEwpOyByZXR1cm4gTDsgfQogIGZ1bmN0aW9uIHN2Z1JlY3QoeCx5LHcsaCxyLGZpbGwpeyBjb25zdCBSPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUygnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnLCdyZWN0Jyk7IFIuc2V0QXR0cmlidXRlKCd4Jyx4KTsgUi5zZXRBdHRyaWJ1dGUoJ3knLHkpOyBSLnNldEF0dHJpYnV0ZSgnd2lkdGgnLHcpOyBSLnNldEF0dHJpYnV0ZSgnaGVpZ2h0JyxoKTsgUi5zZXRBdHRyaWJ1dGUoJ3J4JyxyKTsgUi5zZXRBdHRyaWJ1dGUoJ2ZpbGwnLGZpbGwpOyBzdmcuYXBwZW5kQ2hpbGQoUik7IHJldHVybiBSOyB9CiAgZnVuY3Rpb24gc3ZnVGV4dCh4LHksc3RyKXsgY29uc3QgVD1kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoJ2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJywndGV4dCcpOyBULnNldEF0dHJpYnV0ZSgneCcseCk7IFQuc2V0QXR0cmlidXRlKCd5Jyx5KTsgVC5zZXRBdHRyaWJ1dGUoJ3RleHQtYW5jaG9yJywnbWlkZGxlJyk7IFQuc2V0QXR0cmlidXRlKCdmb250LXNpemUnLCcxMicpOyBULnNldEF0dHJpYnV0ZSgnZm9udC13ZWlnaHQnLCc3MDAnKTsgVC5zZXRBdHRyaWJ1dGUoJ2ZpbGwnLCcjZmZmJyk7IFQudGV4dENvbnRlbnQ9c3RyOyBzdmcuYXBwZW5kQ2hpbGQoVCk7IHJldHVybiBUOyB9CiAgZnVuY3Rpb24gbWFrZVdhdGVyKHgseSl7IGNvbnN0IGlkPSd3JytNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKTsgY29uc3QgZWw9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7IGVsLmNsYXNzTmFtZT0nd2F0ZXInOyBlbC5zdHlsZS5sZWZ0PXgrJ3B4JzsgZWwuc3R5bGUudG9wPXkrJ3B4JzsgZWwudGV4dENvbnRlbnQ9J0jigoJPJzsgZWwuZGF0YXNldC5pZD1pZDsgYm9hcmQuYXBwZW5kQ2hpbGQoZWwpOyB3YXRlcnMucHVzaCh7aWQsIGVsfSk7IGxldCBkcmFnPW51bGw7IGVsLmFkZEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJkb3duJywoZSk9PnsgZS5zdG9wUHJvcGFnYXRpb24oKTsgZWwuc2V0UG9pbnRlckNhcHR1cmUoZS5wb2ludGVySWQpOyBjb25zdCByZWN0PWJvYXJkLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOyBkcmFnPXtveDplLmNsaWVudFgtcmVjdC5sZWZ0LXBhcnNlRmxvYXQoZWwuc3R5bGUubGVmdCksIG95OmUuY2xpZW50WS1yZWN0LnRvcC1wYXJzZUZsb2F0KGVsLnN0eWxlLnRvcCl9OyB9KTsgYm9hcmQuYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlcm1vdmUnLChlKT0+eyBpZighZHJhZykgcmV0dXJuOyBjb25zdCByZWN0PWJvYXJkLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOyBlbC5zdHlsZS5sZWZ0PShlLmNsaWVudFgtcmVjdC5sZWZ0LWRyYWcub3gpKydweCc7IGVsLnN0eWxlLnRvcD0oZS5jbGllbnRZLXJlY3QudG9wLWRyYWcub3kpKydweCc7IH0pOyBlbC5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVydXAnLCgpPT57IGRyYWc9bnVsbDsgfSk7IGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2RibGNsaWNrJywoKT0+eyBlbC5yZW1vdmUoKTsgY29uc3QgaT13YXRlcnMuZmluZEluZGV4KHc9PncuaWQ9PT1pZCk7IGlmKGk+PTApIHdhdGVycy5zcGxpY2UoaSwxKTsgfSk7IHJldHVybiBlbDsgfQoKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzZXQnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpPT57IHdoaWxlKHN2Zy5maXJzdENoaWxkKSBzdmcucmVtb3ZlQ2hpbGQoc3ZnLmZpcnN0Q2hpbGQpOyBpdGVtcy5mb3JFYWNoKGl0PT5pdC5lbC5yZW1vdmUoKSk7IGl0ZW1zLmxlbmd0aD0wOyBib25kcy5sZW5ndGg9MDsgd2F0ZXJzLmZvckVhY2godz0+dy5lbC5yZW1vdmUoKSk7IHdhdGVycy5sZW5ndGg9MDsgcGFpcnMuZm9yRWFjaChwPT5wLmxpbmUucmVtb3ZlKCkpOyBwYWlycy5sZW5ndGg9MDsgfSk7Cn0pKCk7Cjwvc2NyaXB0Pgo8L2JvZHk+CjwvaHRtbD4K"></iframe>
</div></section>

<section id="tab-poly" class="tab"><div class="panel">
  <!-- 多糖合成：占位提示。您可以根据之前的多糖实现将其补全。 -->
  <div style="padding:20px; color:var(--ink); font-size:14px;">多糖合成模块暂未内嵌，请根据先前实现补充。</div>
</div></section>

<section id="tab-lipid" class="tab"><div class="panel" id="lipid-panel">
  <!-- 控制按钮：放水、放 NaOH、重置 -->
  <div class="controls">
    <button class="btn" id="lip-add-water">放水</button>
    <button class="btn" id="lip-add-naoh">放 NaOH</button>
    <button class="btn" id="lip-reset">重置</button>
  </div>
  <!-- 调色板：提供甘油、两种脂肪酸、磷脂头 -->
  <div class="palette" id="lip-pal">
    <div class="card gly" data-type="gly">
      <div class="c">C</div><div class="oh">OH</div>
      <div class="c">C</div><div class="oh">OH</div>
      <div class="c">C</div><div class="oh">OH</div>
    </div>
    <div class="card fa" data-type="fa" data-kind="saturated">
      <span class="label">饱和</span>
      <div class="hooc">COOH</div>
      <div class="chain">CH3(CH2)6CH3</div>
    </div>
    <div class="card fa" data-type="fa" data-kind="unsaturated">
      <span class="label">不饱和</span>
      <div class="hooc">COOH</div>
      <div class="chain">CH3CH2CH=CHCH2CH2CH3</div>
    </div>
    <div class="card head" data-type="head">
      <div class="choline">胆碱</div>
      <div class="phos">P</div>
      <div class="ho">OH</div>
    </div>
  </div>
  <!-- 内部绘图层 -->
  <svg id="lip-sv" xmlns="http://www.w3.org/2000/svg"></svg>
</div></section>

<script>
// ================== 标签切换 ==================
document.querySelectorAll('.tab-btn').forEach(btn =>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
  });
});

// ================== 脂肪模块交互 ==================
(function(){
  const panel = document.getElementById('lipid-panel');
  const svg   = document.getElementById('lip-sv');
  const pal   = document.getElementById('lip-pal');
  const addWaterBtn = document.getElementById('lip-add-water');
  const addNaohBtn  = document.getElementById('lip-add-naoh');
  const resetBtn    = document.getElementById('lip-reset');
  let items=[]; // 保存放置在面板中的元素
  let bonds=[]; // 保存形成的键，包含酯键和磷酸酯键
  let waters=[]; // 水滴列表
  let soaps=[];  // 肥皂列表
  let naohs=[];
  let drag=null;
  let idCounter=0;
  const LIP_BOND_NEAR=40;
  // 函数：生成唯一 id
  function newId(){ return 'l'+(idCounter++).toString(36); }
  // 工具：获取元素的外边框中心点（用来判定距)
  function centerRect(el){ const r=el.getBoundingClientRect(); const pr=panel.getBoundingClientRect(); return {x:r.left - pr.left + r.width/2, y:r.top - pr.top + r.height/2}; }
  // 工具：计算两元素外边缘之间的最近点连线，用于绘制边缘到边缘的连线
  function edgeLine(aEl,bEl){ const a=centerRect(aEl), b=centerRect(bEl); const dx=b.x-a.x, dy=b.y-a.y; const d=Math.hypot(dx,dy)||1; const ax=a.x + dx/d*(aEl.offsetWidth/2), ay=a.y + dy/d*(aEl.offsetHeight/2); const bx=b.x - dx/d*(bEl.offsetWidth/2), by=b.y - dy/d*(bEl.offsetHeight/2); return {x1:ax,y1:ay,x2:bx,y2:by,mx:(ax+bx)/2,my:(ay+by)/2}; }
  // 工具：检查两外边框是否靠近
  function closeEnough(aEl,bEl){ const a=centerRect(aEl), b=centerRect(bEl); return Math.hypot(a.x-b.x,a.y-b.y) < LIP_BOND_NEAR; }
  // 绘制一条键线以及文字标签
  function drawBondLine(aEl,bEl,label){ const coords=edgeLine(aEl,bEl); const l=document.createElementNS('http://www.w3.org/2000/svg','line'); l.setAttribute('x1',coords.x1); l.setAttribute('y1',coords.y1); l.setAttribute('x2',coords.x2); l.setAttribute('y2',coords.y2); l.setAttribute('class','bond-line'); svg.appendChild(l); const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',coords.mx); t.setAttribute('y',coords.my+4); t.setAttribute('text-anchor','middle'); t.setAttribute('class','bond-label'); t.textContent=label; svg.appendChild(t); return {line:l,label:t,center:{x:coords.mx,y:coords.my}}; }
  // 创建水滴或NaOH
  function createDroplet(type,x,y){ const el=document.createElement('div'); el.className=type; el.style.left=(x-20)+'px'; el.style.top=(y-20)+'px'; el.textContent = type==='naoh'?'NaOH':(type==='soap'?'肥皂':'' ); panel.appendChild(el); return el; }
  // 处理拖拽开始
  panel.addEventListener('pointerdown',ev=>{
    const target = ev.target.closest('.card, .water, .naoh');
    if(!target) return;
    ev.preventDefault();
    if(target.dataset && target.dataset.type){
      // palette 中拖拽新建一个
      if(target.closest('#lip-pal')){
        const clone=target.cloneNode(true);
        clone.dataset.id=newId();
        clone.style.position='absolute';
        clone.style.left=(ev.offsetX - target.offsetWidth/2)+'px';
        clone.style.top =(ev.offsetY - target.offsetHeight/2)+'px';
        clone.classList.add('draggable');
        panel.appendChild(clone);
        // 若为甘油，则标记每个 OH 元素可用
        if(clone.dataset.type==='gly'){
          clone.dataset.free='3';
        }
        items.push({id:clone.dataset.id,el:clone,type:clone.dataset.type});
        drag={id:clone.dataset.id, offsetX:ev.offsetX - parseFloat(clone.style.left), offsetY:ev.offsetY - parseFloat(clone.style.top)};
      }else{
        // 拖拽已有水/naoh
        drag={droplet:target, offsetX:ev.offsetX - parseFloat(target.style.left), offsetY:ev.offsetY - parseFloat(target.style.top)};
      }
    }
  });
  panel.addEventListener('pointermove',ev=>{
    if(!drag) return;
    ev.preventDefault();
    if(drag.id){ // 拖拽化合物
      const it=items.find(x=>x.id===drag.id);
      if(!it) return;
      it.el.style.left=(ev.offsetX - drag.offsetX)+'px';
      it.el.style.top =(ev.offsetY - drag.offsetY)+'px';
    }else if(drag.droplet){ // 拖拽水/NaOH
      drag.droplet.style.left=(ev.offsetX - drag.offsetX)+'px';
      drag.droplet.style.top =(ev.offsetY - drag.offsetY)+'px';
    }
    refreshLines();
  });
  panel.addEventListener('pointerup',ev=>{
    if(!drag) return;
    if(drag.id){ // 停止拖动化合物，尝试成键
      const it=items.find(x=>x.id===drag.id);
      if(it && (it.type==='fa' || it.type==='gly' || it.type==='head')){
        // 尝试与其他物质缩合
        for(const other of items){ if(other.id===it.id) continue;
          // 甘油与脂肪酸: OH + COOH
          if((it.type==='fa' && other.type==='gly') || (it.type==='gly' && other.type==='fa')){
            const fa = it.type==='fa'?it:other;
            const gly= it.type==='gly'?it:other;
            if(closeEnough(fa.el.querySelector('.hooc'), gly.el.querySelectorAll('.oh')[0])){
              // 创建酯键
              const bond = drawBondLine(fa.el.querySelector('.hooc'), gly.el.querySelectorAll('.oh')[0], '—O—C(=O)—');
              bonds.push({fa:fa.id, gly:gly.id, bond, type:'ester'});
              // 隐藏文本但保留方框
              fa.el.querySelector('.hooc').textContent='';
              gly.el.querySelectorAll('.oh')[0].textContent='';
              // 生成水滴
              const w=createDroplet('water', bond.center.x, bond.center.y - 30);
              waters.push({el:w,bond});
            }
          }
          // 甘油与磷脂头: OH + OH (磷脂头只有一个 OH)
          if((it.type==='head' && other.type==='gly') || (it.type==='gly' && other.type==='head')){
            const head= it.type==='head'?it:other;
            const gly = it.type==='gly'?it:other;
            const headOH = head.el.querySelector('.ho');
            const glyOH  = gly.el.querySelectorAll('.oh')[1];
            if(closeEnough(headOH, glyOH)){
              const bond = drawBondLine(headOH, glyOH, '磷酸酯键');
              bonds.push({fa:head.id, gly:gly.id, bond, type:'phos'});
              headOH.textContent='';
              glyOH.textContent='';
              const w=createDroplet('water', bond.center.x, bond.center.y - 30);
              waters.push({el:w,bond});
            }
          }
        }
      }
    }else if(drag.droplet){
      const drop=drag.droplet;
      // 水解或皂化
      for(const b of bonds){
        const mid=b.bond.center;
        const dx = mid.x - (parseFloat(drop.style.left)+20);
        const dy = mid.y - (parseFloat(drop.style.top)+20);
        if(Math.hypot(dx,dy) < LIP_BOND_NEAR){
          // 删除键线和标签
          b.bond.line.remove();
          b.bond.label.remove();
          // 恢复文本（若是酯键，则恢复 HOOC 与 OH；若是磷酸酯键则恢复 HO 与 OH）
          const faEl = items.find(x=>x.id===b.fa).el;
          const glyEl= items.find(x=>x.id===b.gly).el;
          if(b.type==='ester'){
            faEl.querySelector('.hooc').textContent='COOH';
            glyEl.querySelectorAll('.oh')[0].textContent='OH';
          }else{
            faEl.querySelector('.ho').textContent='OH';
            glyEl.querySelectorAll('.oh')[1].textContent='OH';
          }
          // 若是 NaOH 则替换为肥皂
          if(drop.classList.contains('naoh')){
            faEl.querySelector('.hooc').textContent='COO⁻Na⁺';
            const soap=createDroplet('soap', mid.x+40, mid.y);
            soaps.push({el:soap});
          }
          // 移除水滴/NaOH本身
          drop.remove();
          // 移除对应的水滴条目
          for(const w of waters){ if(w.el===drop){ waters.splice(waters.indexOf(w),1); break; } }
          for(const n of naohs){ if(n.el===drop){ naohs.splice(naohs.indexOf(n),1); break; } }
          // 移除此键
          bonds.splice(bonds.indexOf(b),1);
          break;
        }
      }
    }
    drag=null;
  });
  // 刷新连线位置
  function refreshLines(){ bonds.forEach(b=>{
    const faEl = items.find(x=>x.id===b.fa).el;
    const glyEl= items.find(x=>x.id===b.gly).el;
    let aEl,bEl;
    if(b.type==='ester'){
      aEl=faEl.querySelector('.hooc'); bEl=glyEl.querySelectorAll('.oh')[0];
    }else{
      aEl=faEl.querySelector('.ho'); bEl=glyEl.querySelectorAll('.oh')[1];
    }
    const coords=edgeLine(aEl,bEl);
    b.bond.line.setAttribute('x1',coords.x1);
    b.bond.line.setAttribute('y1',coords.y1);
    b.bond.line.setAttribute('x2',coords.x2);
    b.bond.line.setAttribute('y2',coords.y2);
    b.bond.label.setAttribute('x',coords.mx);
    b.bond.label.setAttribute('y',coords.my+4);
    b.bond.center=coords;
  }); }
  // 控制按钮
  addWaterBtn.addEventListener('click',()=>{
    const w=createDroplet('water', 60, 420);
    waters.push({el:w});
  });
  addNaohBtn.addEventListener('click',()=>{
    const n=createDroplet('naoh', 120, 420);
    naohs.push({el:n});
  });
  resetBtn.addEventListener('click',()=>{
    // 清除面板内容
    items.forEach(it=>it.el.remove()); items=[];
    bonds.forEach(b=>{b.bond.line.remove(); b.bond.label.remove();}); bonds=[];
    waters.forEach(w=>w.el.remove()); waters=[];
    naohs.forEach(n=>n.el.remove()); naohs=[];
    soaps.forEach(s=>s.el.remove()); soaps=[];
  });
})();
</script>
</body>
</html>